---
title: "Tesis de Licenciatura"
author: "Paola Corrales"
date: ''
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 4
    keep_tex: yes
  word_document:
    reference_docx: word-template.docx
    toc: yes
    toc_depth: '4'
documentclass: book
classoption: oneside

geometry: inner = 3cm, outer = 2cm, top = 2.5cm, bottom = 2.5cm
header-includes:
  - \linespread{1.25}
  - \usepackage{subfig}
  - \usepackage{hyperref}
#  - \usepackage{mathtools}
lang: es-AR
link-citation: yes
fontsize: 12pt
subtitle: Desarrollo de una metodología de trabajo para caracterizar el ciclo diurno
  del viento en la capa límite atmosférica a partir de datos de radar meteorológico
  y su posterior uso para la validación de modelos.
bibliography:
- Bibliografia/papers.bib
- Bibliografia/packages.bib
csl: Bibliografia/meteorologica.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE)

knitr::write_bib(c("base", "data.table", "ggplot2", "metR"), 
                 file = "Bibliografia/packages.bib")

library(metR)
library(ggplot2)
library(lubridate)
library(magrittr)
library(dplyr)
library(dtplyr)
library(viridis)
library(directlabels)
library(data.table)
library(patchwork)
library(ncdf4)
#source("geom_contourlabel.R")
source("helpfun.R")
```

\listoffigures
\newpage

\listoftables
\newpage

\section*{Agradecimientos}
\newpage

\section*{Resumen}
\newpage

# Introducción

La capa límite planetaria (CLP) corresponde a la porción de atmósfera que se encuentra directamente influenciada por la superficie y que responde a sus forzantes en una escala de tiempo de una hora o menos [@Stull1988]. Los procesos que ocurren dentro de esta capa son de suma importancia para entender y pronosticar la evolución de la atmósfera en distintas escalas espaciales y temporales. En particular estos procesos controlan el intercambio de energía entre la superficie y la atmósfera afectando, entre otras cosas, las condiciones para la ocurrencia de convección húmeda profunda y la intensidad de las circulaciones de mesoescala, que tienen un alto impacto sobre las actividades humanas.

En nuestra región existen estudios que buscan caracterizar los procesos que ocurren en la capa límite de forma tal de poder avanzar en su entendimiento y su dependencia por ejemplo con las propiedades de la superficie o el estado de la atmósfera [@Mazzeo1990; @Ulke2000; @Gassmann2001; @Acevedo2014; @Tonti2015].

Dado que la ocurrencia de turbulencia en la  capa límite planetaria se da en múltiples escalas espaciales y temporales, la representación de los procesos que ocurren dentro de ella es un desafío para los modelos numéricos. Actualmene los modelos de simulación regional y global no cuentan con la resolución necesaria para representar los procesos de la CLP de forma explícita, debiendo recurrir a una representación simplificada. De esta manera se simula numéricamente una parte del espectro turbulento, mientras que los procesos en la escala de subgrilla se resuelven a través de parametrizaciones con cierres de distinto orden, es decir, con diferentes niveles de aproximaciones. 

Existen diferentes alternativas para parametrizar los procesos de capa límite pero pueden clasificarse en dos grandes grupos. De acuerdo a @Stull1988, las parametrizaciones con clausura local determinan el valor de cualquier variable desconocida en cada punto a partir del valor o el gradiente de una variable conocida en el mismo punto; suponiendo que la turbulencia tiene un comportamiento análogo a la difusión molecular. Por otro lado las parametrizaciones con clausura no local asumen que la turbulencia está caracterizada por la superposición de torbellinos de distintas escalas que transportan las características del medio; y para lograr esto, el valor de la variable desconocida en un punto es aproximada a partir de una variable conocida en varios puntos en el espacio. 

La validación de las parametrizaciones de CLP en distintas situaciones sinópticas es un tema de gran interés debido a la necesidad de modelas los procesos de subgrilla presentes que afectan procesos en el resto de las escalas de variabiliad atmosférica [@Xie2012; @Banks2016]. 

A nivel regional, la representación de la capa límite en los modelos numéricos ha recibido mucha atención en las zonas oceánicas (particularmente en los océanos tropicales, @Wang2004). Sin embargo, existen pocos estudios acerca del desempeño de las parametrizaciones de capa límite en las regiones continentales [@Ulke2001; @Ruiz2010; @Berri2012; @Rizza2013].

Uno de los principales desafíos a la hora de estudiar los procesos que ocurren en la capa límite o para validar cómo los modelos representan dichos procesos, es la disponibilidad de observaciones. Las redes de radiosondeos que permiten obtener perfiles de viento, temperatura y humedad en la capa límite miden con frecuencias temporales de entre 12 y 24 horas (solo eventualmente cada 6 horas) lo que impide analizar la evolución de las características de la CLP a lo largo del día.

Sin embargo los radares Doppler permiten estimar la componente radial del viento en un radio horizontal de hasta 240 km y a partir de esa información permiten reconstruir perfiles verticales de viento utilizando la técnica Velocity Azimuth Display (VAD). 

En días en los que no existen ecos producidos por hidrometeoros, los radares pueden detectar la velocidad del viento dentro de la capa límite a partir de blancos como los insectos, de acuerdo a @Rennie2010 estos datos podrían ser utilizados si se elimina el efecto de los ecos de terreno y otras observaciones erroneas. Las observaciones de radar están disponibles con una frecuencia temporal de hasta 5 minutos permitiendo obtener perfiles de viento con una resolocuón temporal mucho mayor. 

La calidad de estos perfiles ha sido comparada con los perfiles obtenidos a partir de radiosondeos, encontrándose en general que los datos obtenidos resultan adecuados para su uso en el estudio de los procesos de capa límite y en la verificación de modelos numéricos [@Bousquet2008; @Salonen2008] y en la generación de condiciones iniciales para pronósticos a muy corto plazo [@Rennie2011].

Uno de los aspectos importantes a tener en cuenta en el uso de radares para el estudio de los perfiles de viento, es la necesidad de aplicar un riguroso control de calidad a los datos  que permita solucionar diversos aspectos que pueden afectar la confiabilidad de los mismo. Entre los problemas más comunes se cuentan: contaminación por ecos de terreno, efecto de aliasing, y contaminación por blancos móviles. Estos aspectos deben ser abordados antes de poder utilizar los datos para estimar el perfil de velocidad [@Holleman2008; @Rennie2011] aplicando algoritmos de control de calidad [@Ruiz2015; @Rennie2011].

La disponibilidad de la información de radar Doppler en Argentina ofrece un gran recurso de información para estudiar las propiedades de la capa límite planetaria en nuestra región y para validar la calidad de los modelos numéricos a la hora de representar dichas propiedades.

El objetivo de esta Tesis de Licenciatura es desarrollar una metodología para el estudio de los procesos de capa límite a partir de los datos de radar y analizar el comportamiento de distintas parametrizaciones de CLP disponibles en el modelo Weather Research and Forecasting (WRF - @Skamarock2008) al representar algunos de los procesos presentes a lo largo del día. 

Se plantea como hipótesis que los datos de viento radial obtenidos de información de radar permiten estimar los perfiles verticales de viento con una frecuencia temporal de 10 minutos, en un espesor que abarca desde superficie y hasta 2000 m de altura, permitiendo realizar una caracterización de la evolución temporal de dichos perfiles dentro de la capa límite atmosférica. La estimación de esos perfiles permitirán además validar las parametrizaciones de la capa límite que utilizan los modelos numéricos con una mayor resolución temporal a la utilizada en trabajos previos.

Para alcanzar el obejtivo se realizó el siguiente procedimiento: En primer lugar se determinaron las características necesarias para identificar posibles casos de estudio que permitan analizar los procesos de CLP asociados al ciclo diario. Luego se procesó los datos de radar para caso en estudio y se aplicaron los controles de calidad necesarios antes de realizar el cálculo del VAD desarrollado y validado como parte de este trabajo. Se analizó la consistencia de los resultados obtenidos y las características principales de la variación del viento a lo largo del día. Para las simulaciones numéricas con el modelo WRF se define un dominio y condiciones iniciales adecuadas para modelar un caso de estudio utilizando algunas parametrizaciones diponibles. Se comparan las simulaciones con las observaciones previamente obtenidas y se analizan algunas variables asociadas a la turbulencia. 

De esta manera, este trabajo permite desarrollar una metodología para el tratamiento de observaciones no convencionales, su aplicación al estudio de los procesos de CLP y al modelado numérico de los mismos.

# Metodología

En esta sección se describen los datos utilizados en el trabajo y las metodologías aplicadas al análisis.

## Región y casos de estudio

Este trabajo centra el análisis en la región de la ciudad de Paraná (provincia de Entre Ríos, Argentina) donde se encuentran el Radar Doppler del INTA (Instituto Nacional de Tecnología Agropecuaria) y una estación meterológica de superficie perteneciente al SMN (Servicio Meteorológico Nacional) separados por aproximadamete 9 kilometros de distancia.

```{r topografia, fig.cap="Topografía de la región en estudio en metros sobre el nivel del mar. El punto negro indica la ubicación del Radar INTA Paraná, el punto rojo indica la ubicación de la estación Paraná Aero. \\label{topografia}", fig.scap="Topografía de la región en estudio en metros sobre el nivel del mar.", out.width="0.75\\textwidth", fig.align='center'}
topo <- GetTopography(298.96, 299.95, -31.44, -32.25, resolution = 1/60, file.dir = "seudocache") %>% 
  .[, lon := ConvertLongitude(lon, from = 360)]

ggplot(topo, aes(lon, lat)) + 
  geom_contour_fill(aes(z = h)) +
  scale_fill_distiller(type = "seq", palette = "YlOrBr", 
                       name = "",
                       guide = guide_colorbar(title.position = "top", 
                                              title.hjust = 0.5)) +
  scale_x_continuous(name = "Longitud", limits = c(-61.04, -60.05), expand = c(0,0)) +
  scale_y_continuous(name = "Latitud", limits = c(-32.25, -31.44), expand = c(0,0)) +
  annotate(geom = "point", x = -60.537289, y = -31.848438, size = 2) +
  annotate(geom = "point", x = -60.483333, y = -31.783333, size = 2, color = "red") +
  coord_quickmap() + 
  theme_minimal() + theme(panel.ontop = T)

remove(topo)
```

La elevación de la región elegida muestra un mínimo de 5 metros sobre el nivel del mar en la cuenca del Río Paraná y un máximo de aproximadamente 110 metros sobre el nivel del mar sobre el margen sudeste de río donde ubica tanto la estación meteorológica como el radar (Figura \ref{topografia}). La región está dominada por la presencia del río y las regiones costeras donde predominan los campos de pastizales o pasto con excepción la ciudad de Paraná (al norte), la ciudad de Santa Fé (al noreste) y pequeños conglomerados de casas. 

### Criterios utilizados para la selección de los casos de estudio

Con el obejtivo analizar los procesos que ocurren en la CLP a lo largo del día es necesario identificar aquellas condiciones atmosféricas que permitan el desarrollo de la capa límite y al mismo tiene donde los datos de radar sean confliables. Por lo tanto se buscaron cumplir los siguientes criterios:

* **Viento moderado.** En estas situaciones los datos de radar son más confiables y permiten el desarrollo de la capa límite estable nocturna [@Gassmann2001].
* **Cielos despejados.** Para garantizar el calentamiento desde la superficie y el desarrollo de una capa límite mezclada.
* **Verano.** Donde el calentamiento es más intenso.

Las características previas se buscaron a partir del análisis de los datos de la estación meteorológica de superficie Paraná Aero provistos por el SMN y de reflextividad (dBZ) del radar de Paraná para los meses de enero de 2016 y 2017. 

En el primer tipo de datos se analizó la velocidad de viento, la cobertura nubosa y la precipitación observada a cada hora. En el caso de los datos de radar se observó la presencia de ecos meteorológicos en las inmediaciones del radar (a una distancia menor a 150 km) en cada tiempo disponible (aproximadamente cada 10 minutos). Un caso de estudio posible será aquel que cumpla con las características mencionadas durante las 24 horas del día aunque es deseable que las condiciones se mantengan durante las 12 horas previas al día en estudio ya que las características de la capa estable nocturna puede ser influenciada por las características de la capa mezcalda del día anterior.

### Descripción de los casos de estudio

A partir de análisis previamente descripto se identificaron 3 casos de estudio que se describen a continuación.

#### Caso 1: 14 de enero de 2016

El caso 1 abarca el perdiodo de las 00 UTC del 14 de enero a las 00 UTC del 15 de enero de 2016. A escala regional se observó un anticiclón ubicado sobre el oceano Atlántico y al este Uruguay a las 00 UTC de 14 de enero. Este sistema está asociado a vientos del noreste sobre el dominio en estudio. En superficie se registraron vientos débiles (menores a 2 m/s) del este y sureste en las primeras horas del periodo. En la estación meteorológica se observó nubosidad alta en las primeras horas de tipo cirroestrato que por momentos cortos cubrió el cielo. No se observaron ecos meteorológicos en la región del radar. **Que tanto afecta la nubosidad alta?**

Posteriormente, a las 12 UTC el anticiclón se intensifica y comienza a moverse hacia el NE y en superficie se observan vientos predominantes del noreste de hasta 6.5 m/s. No se observa nubosidad y la temperatura en superficie alcanza los 32.4°C.

**Humedad relativa disminuye de 85% a 35% en el periodo, no me queda clara la causa y tampoco se que tan importante puede ser esto luego**

## Descripción de los datos de radar

El radar ubicado en Paraná (Provincia de Entre Ríos) emite energía electromagnética en la banda C (4 a 8 GHz) y es de doble polarización.
La estrategia de escaneo de la atmósfera está programada para que la antena de giros en sentido horizontal de 360º y cambie de elevación sucesivamente 12 veces. El ángulo vertical varía entre 0.5° y 15.1°. El rango del radar (distancia a la que llega la señal desde la ubicación del radar) puede ser de 120, 240 y 480 km con una resolución espacial de 1 $\mathrm{km^2}$ [@Saibene2014] de acuerdo a la estrategía de escaneo.

El escaneo completo se realiza cada 10 minutos, dando 144 volumenes de datos
diarios registrando para las distintas variables como reflectividad (dBZ) y velocidad
radial ($V_r$).

En este trabajo se usaron datos de radar con un rango de 240 km y 12 ángulos de elevación para los periodos comprendidos por cada caso de estudios provistos por **XXXX INTA XXXX**

Cada volumen de dato correspondiente a un tiempo de escaneo completo fue convertido al formato CfRadial con el paquete Radx C++ desarrollado por Mike Dixon (NCAR - National Center for Atmospheric Research) **CITA** para el posterior procesamiento y análisis. 
En particular se utilizó la variable de reflectividad sin procesamiento para determinar la presencia o no de ecos meteorológicos en el dominio cercano al radar y la velocidad radial para la obtención de los perfiles de viento. 

## Tratamiento de aliassing

Un problema importante al momento de utilizar los datos de velocidad radial es la contaminación por aliasing ya que afecta significativamente la calidad de los perfiles de viento finales, de acuerdo a @Gao2004 un 3% de contaminación por aliassing puede generar un error cuadratico medio del 50% en el perfil de viento medio a partir de la técnica VAD. El aliasing es la superposición de la señal de radar y ocurre cuando la velocidad real supera a la velocidad de Nyquist ($V_N$). Este parámetro es intrínceco a las características del radar ya que depende de la frecuencia y estrategía de escaneo y en particular de la frecuencia de repetición del pulso o señal que emite.

En el caso del radar de Paraná con la estrategía de escaneo de 240km de rango, tiene una $V_N = 6.7 m/s$ por lo que cualquier velocidad mayor se verá afectada por el aliasing. Esto puede verse en la Figura \ref{aliasing}, las regiones con aliasing se son aquellas que donde el valor de la velocidad radial salta al extremo opuesto de la escala. 

Existen muchos algoritmos que buscan solucionar el problema del aliasing [por ejemplo @Haase2004; @Lim2010] con distinto grado de exito. Una opción válida es el algoritmo de corrección de aliasing basado en regiones similares disponible en la librería PyART [@Helmus2016], este algoritmo busca regiones con velocidad radial similar y transforma el rango de la variable hasta que todas las regiones fueron corregidas de tal manera de obtener un campo continuo. El campo de velocidad radial sin aliasing obtenido utilizando este algoritmo se muestra en la Figura \ref{no-aliasing}. 

A partir de la exploración visual puede observarse que el algoritmo resuelve el problema de manera satisfactoria y por esta razón se utilizará para preprocesar todos los volumenes de datos de radar.

```{r aliasing, fig.cap="Velocidad radial (m/s) observada a las 06 UTC por el radar de Paraná en la elevación $1.3^{\\circ}$ y $V_N = 6.7 m/s$. Notar las escalas diferentes.", fig.subcap=c("Con aliasing \\label{aliasing}", "Sin aliasing \\label{no-aliasing}"), out.extra=" ", out.width="0.48\\textwidth"}

map <- setDT(fortify(rnaturalearth::ne_states(country = "Argentina"))) %>%
  .[, rango := range(long, lat)] %>% 
  .[, azimut := azimuth(long, lat)]

radar <- nc_open("seudocache/cfrad.20160114_060005.000_to_20160114_060431.001_INTA_Parana_SUR.nc")
azimut <- ncvar_get(radar, 'azimuth')   
elevacion <- ncvar_get(radar, 'elevation') 
rango <- ncvar_get(radar, 'range')      
V <- ncvar_get(radar, 'V')            
Vda <- ncvar_get(radar, 'Vda')
Vda[Vda > 99999] <- NA
elev <- unique(elevacion)

dimnames(V) <- list(rango = rango, azimut = azimut)
radar <- setDT(melt(V, value.name = "V")) 
radar[, elevacion := elevacion, by = rango]
radar[, Vda := c(Vda)]

radar[elevacion == elev[3] & !is.na(V), ] %>%
  RepeatLon(., colname = "azimut") %>% 
  ggplot(aes(azimut, rango/1000)) + 
  geom_path(data = map[rango <= 300*1000], aes(group = group), color = "darkgray") +
  geom_point(aes(color = V, size = rango)) +
  scale_color_divergent() +
  scale_size_area(max_size = 0.1) +
  scale_x_continuous(name = NULL, labels = NULL, breaks = seq(0, 359, 90)) +
  scale_y_continuous(name = "Distancia al centro (Km)", breaks = c(40, 120, 180, 240), 
                     limits = c(0, 300), expand = c(0, 0)) + 
  guides(size = "none") +
  coord_polar() +
  theme_minimal() + theme(legend.position = "bottom")

radar[elevacion == elev[3] & !is.na(Vda), ] %>%
  RepeatLon(., colname = "azimut") %>% 
  ggplot(aes(azimut, rango/1000)) + 
  geom_path(data = map[rango <= 300*1000], aes(group = group), color = "darkgray") +
  geom_point(aes(color = Vda, size = rango)) +
  scale_color_divergent(name = expression(V[da])) +
  scale_size_area(max_size = 0.1) +
  scale_x_continuous(name = NULL, labels = NULL, breaks = seq(0, 359, 90)) +
  scale_y_continuous(name = "Distancia al centro (Km)", breaks = c(40, 120, 180, 240), 
                     limits = c(0, 300), expand = c(0, 0)) + 
  guides(size = "none") +
  coord_polar() +
  theme_minimal() + theme(legend.position = "bottom")

#V.plot + Vda.plot
```

## Velocity Azimuth Display (VAD)

A medida que el radar rota en la dirección azimutal, mide la velocidad de los objetivos para cada ángulo y rango de manera continua y en función del azimut. A esto se le da el nombre de Visualización Azimutal de la Velocidad o por sus siglas en inglés VAD (por Velocity Azimuth Display, @Lhermitte1962) y se muestra en la Figura \ref{vad}. Si el campo de viento es horizontalmente homogeneo, la velocidad radial media tiene un comportamiento sinusoidal en función del azimut. 

```{r vad, fig.cap="Velocidad radial (m/s) en función del azimut (grados) para un rango y ańgulo de elevación fijos. En color se  ajusta una función sinusoidal a los datos. \\label{vad}", out.width="0.75\\textwidth", fig.align='center'}
ggplot(radar[rango %~% 4000 & elevacion == elev[3], ], aes(azimut, Vda)) +
  geom_line() +
  geom_smooth(method = "lm", formula = y ~ I(sin(x*pi/180)) + I(cos(x*pi/180)), se = F, color = "#20968b") +
  scale_y_continuous(name = "Velocidad radial (m/s)") +
  scale_x_continuous(name = "Azimut (grados)") +
  geom_hline(yintercept = 0) +
  theme_minimal()
```

De esta manera, la velocidad radial medida por el radar corresponde a la velocidad de un objetivo u obstaculo en el camino del haz. En situaciones de aire claro (sin nubosidad) es posible tener una medida del campo de viento dentro de la capa límite usando insectos como obstaculos. Sin embargo esta velocidad no corresponde al campo de movimiento real ya que es medida en la dirección radial siendo los valores negativos movimiento hacia el radar y valores positivos movimientos desde el radar. Mientras que el valor nulo ocurre en las regiones donde la velocidad real es perpendicular a la trayectoria del haz.

A partir de este concepto distintos autores han desarrollado técnicas para obtener el perfil vertical de viento real a partir del viento radial o su gradiente con diferentes grados de complejidad. Estas técnicas son también son llamdas VAD (o sus derivaciones, @Browning1968; @Matejka1991; @Gao2004a; @Xu2011).  Para esta tesis se desarrolló un algoritmo para el cálculo del VAD siguiendo a @Browning1968 pero incluyendo controles de calidad específicos para asegurar la validez de los resultados.

### Desarrollo matemático

El viento radial medido por el radar para un ángulo de elevación $\theta$ y rango $r$ determinado puede expresarse en función del azimuth $\phi$:

\begin{equation}
\label{eq-vr1}
V_r =  v \cos(\theta) \cos(\phi) + u \cos(\theta) \sin(\phi) - w \sin(\theta)
\end{equation}

Donde $u$, $v$ y $w$ son las componentes del viento en coordenadas cartesianas.

La Ecuación \ref{eq-vr} puede ser expresada como suma de una serie de Fourier de la forma:

\begin{equation}
\label{eq-vr2}
V_r =  \frac{1}{2}a_0 + \sum_{n = 1}^{\infty} (a_n \cos(n\phi) + b_n \sin(n \phi)) 
\end{equation}

Para $n=1$, los coeficientes de Fourier están asociados al viento en el centro del dominio de escaneo (con subindice 0) como:

\begin{equation} \label{eq-vr3}
a_1 = u_0 \cos(\theta) \; y \;
b_1 = v_0 \cos(\theta) 
\end{equation}

A partir de esto es posible ajustar cada anillo de datos de radar, es decir los datos para cada $\theta$ y $r$ realizando una regreción lineal de la forma:

\begin{equation}
\label{eq-vr4}
V_r \sim a_1\cos \phi + b_1 \sin \phi
\end{equation}

Los coeficientes $a_0$, $a_2$ y $b_2$ no incluidos en el algoritmo dan información sobre la divergencia horizontal y otras características del viento, quedando su implementación para futuros trabajos.

Finalmente la velocidad y dirección del viento pueden ser calculadas a partir de los coeficientes (Ecuaciones \ref{eq-vr3}).

Velocidad:

\begin{equation}
\label{eq-vr5}
V = \frac{(a_{1}^{2} + b_{1}^{2})^{1/2}}{\cos(\theta)}
\end{equation}
  
Dirección:

\begin{equation}\label{eq-vr6}
\alpha = \frac{\pi}{2}-\tan^{-1}(\frac{a_1}{b_1}) \; \; si \; b_1 < 0 
\end{equation}
\begin{equation}\label{eq-vr7}
\alpha = \frac{3\pi}{2}-\tan^{-1}(\frac{a_1}{b_1}) \; \; si \; b_1 > 0
\end{equation}

El resultado de lo anterior un valor de la magnitud del viento y su dirección para cada anillo asociado a un ángulo de elevación y rango determinado. Para calcular la altura de cada anillo es necesario conocer la propagación del haz del radar. La propagación depende del indice de refracción de la atmósfera (N) y este a su vez de la densidad del aire y por lo tanto de las condiciones de temperatura y humedad del momento. Existen distintas metodologías para obtener calcular la propagación del haz del radar [@Zeng2014] que varían en su complejidad y precisión. 

En el algoritmo de VAD desarrollado se aplica el modelo 4/3 del radio de la Tierra. Este modelo es utilizado por la mayoría de los programas de procesamiento de datos de radar ya que pese a su simpleza (no toma en cuenta las condiciones de la atmósfera) es aceptable para cualquier ángulo de elevación usado, alturas máximas de entre 10 y 20 km siempre que el grandiente de N esté alrededor de $-1/a$ donde $a$ es el radio de la tierra [@Doviak1993].

Por otro lado se calcula la raiz del error cuadratico medio asociado a cada anillo ($rmse_a$) para estimar la diferencia entre las observaciones y el modelo estimado:

\begin{equation}\label{eq-vr8}
rmse_a = \sqrt {\sum \frac {(V_r - V_{rmod} )^2} {n-3}}
\end{equation}

donde $n$ es el número de observaciones presentes en un anillo particular.

Para obtener un único perfil vertical de viento se interpola un promedio pesado del valor de las variaciones de los anillos de cada capa de atmósfera a una grilla vertical equiespaciada prestablecida. 

El algoritmo identifica los datos de $V$ para cualquier rango y ángulo de elevación que se encuentran en $z \pm d/2$ donde $z$ es el punto de grilla y $d$ es la resolución espacial de la grilla vertical. Para obtener el valor promedion de de $V$ correspondiente a la altura $z$ calcula un promedio pesando la variable por el $rmse_a$ y la distancia de cada anillo al radar $r$. De esta manera los anillos con mayor error y más alejados a punto donde se está estimando la velocidad y dirección del viento tienen menor influencia en el resultado final.  
\begin{equation}\label{eq-vr9}
\bar{V} = \frac {\sum w_i V_i} {\sum w_i}
\end{equation}

Donde $w_i = \frac {1}{rmse_{ai} + r_i}$ y el subindice $i$ cuenta la cantida de datos para cada intervalo $z \pm d/2$. De manera análoga se calcula la dirección del viento para cada punto de grilla vertical.

Finalmente se calcula el error de estimación asociado a cada punto de dos maneras:

* **$rmse_1$**

\begin{equation}\label{eq-vr10} 
rmse_1 = \frac{\sigma}{\sqrt{n}}
\end{equation}

Donde $n$ es la cantidad de anillo en esa capa y  $\sigma^{2}= \frac{\sum (V_i - \bar{V})^2 /rmse_{ai}^2}{\sum 1/rmse_{ai}^2}$ con $\bar{V}$ el promedio pesado de la velocidad del viento para la capa.

Este error relativo da cuenta de la distancia entre el la velocidad promedio calculada para ese nivel y el valor de cada anillo pesada por el error del anillo. De esta manera si el $rmse_{ai}$ es grande la diferencia $(V_i - \bar{V})^2$ tiene menor peso en el error del nivel. Por otro lado el denominador suma la inversa de errores de todos los anillos y por lo tanto mayores errores individuales genran un $rmse_1$ mayor. Es importante notar que $V_i$ y $\bar{V}$ no están necesariamente a la misma altura ya que $\bar{V}$ es el promedio de muchos $V_i$ dentro de una capa. 

* **$rmse_2$**

\begin{equation}\label{eq-vr11}
rmse_2 = \sqrt{\frac{1}{\sum \frac{1}{rmse_{ai}^2}}}
\end{equation}

Este rmse no toma en cuenta la posible dispersión de los valores individuales de los anillos respecto del valor medio pero retiene el error cuadrático medio de cada anillo y calcula la raíz del error cuadrático medio del nivel como la suma de la inversa de los errores individuales. 

### Controles de calidad de los datos

El algoritmo de VAD desarrollado incluye algunos controles de calidad para evitar errores asociados a problemas intrínsecos a los datos de radar. 

#### Antes del ajusta de los datos 

Permiten determinar cuales son los anilos de datos válidos y eliminar posibles errores aleatorios.

* **Ángulos de elevación seleccionados:** La presencia de ecos de terreno pueden generar que los campos de velocidad radial para los primeros ángulos de elevación sean muy ruidosos y sin coherencia espacial. En el otro extremo, los ángulos superiores suelen tener pocos datos válidos (es decir, no dato faltante) debido a la escasa señal cerca del tope de la capa límite y atmósfera libre en días claros. Debido a esto es posible seleccionar el rango de ángulos a ser analizados y utilizados en el cálculo del VAD.
* **Cantidad de datos por anillo:** el algoritmo cuenta la cantidad de datos válidos por anillo y se define un porcentaje de datos faltantes respecto del total, por ejemplo 20%. Si se excede al máximo definido el anillo es descartado. De esta manera se evita la utilización de anillos donde la señal es muy débil.
* **Hueco continuo en un anillo:** Además de los datos faltantes ubicados de manera aleatoria a lo largo de un anillo, los huecos continuos pueden ocurrir debido a la falta de señal en una determinada región. De acuerdo a @Matejka1991 esto puede generar importantes errores en el resultado final, por lo tanto cuando el hueco es mayor a 30° de azimut, el anillo se descarta.
* **Errores aleatorios:** Los errores aleatorios producto de ruido del instrumento pueden ser eliminados utilizando un filtro pasa bajo [@Gao2004]. Este control no elimina anillos pero produce un suavizado de los datos.

#### Luego del ajuste

* **R cuadrado:** El $r^2$ del modelo ajustado (Ecuación \ref{eq-vr4}) permite obtener una medida de
de la calidad de ese modelo respecto de las observaciones. A partir de la exploración de resultados preliminares se observó que la definición de un umbral mínimo para el $r^2$ permite descartar anillos que pese a no tener datos faltanes eran erroneos.

### Validación

## Loess

## Detección del LLJ

## Tratamiento de la turbulencia

## Modelo de Oscilación Inercial

## WRF

### Parametrizaciones

# Resultados

## Análisis descriptivo de los casos
###caracteristicas generales y sinopticas
##Análisis de los VAD obtenidos
##Análisis de la turbulencia
##Análisis cualitativo de la oscilación inercial
##Analisis de las corridas y comparación con obs

# Conclusiones

# Referencias