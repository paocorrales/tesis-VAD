---
title: "Tesis de Licenciatura"
author: "Paola Corrales"
date: ''
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 4
    keep_tex: yes
  word_document:
    reference_docx: word-template.docx
    toc: yes
    toc_depth: '4'
documentclass: book
classoption: oneside

geometry: inner = 3cm, outer = 2cm, top = 2.5cm, bottom = 2.5cm
header-includes:
  - \linespread{1.25}
  - \usepackage{subfig}
  - \usepackage{hyperref}
lang: es-AR
link-citation: yes
fontsize: 12pt
subtitle: Desarrollo de una metodología de trabajo para caracterizar el ciclo diurno
  del viento en la capa límite atmosférica a partir de datos de radar meteorológico
  y su posterior uso para la validación de modelos.
bibliography:
- Bibliografia/papers.bib
- Bibliografia/packages.bib
csl: Bibliografia/meteorologica.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE)

knitr::write_bib(c("base", "data.table", "ggplot2", "metR"), 
                 file = "Bibliografia/packages.bib")

library(metR)
library(ggplot2)
library(lubridate)
library(magrittr)
library(dplyr)
library(dtplyr)
library(viridis)
library(directlabels)
library(data.table)
library(patchwork)
library(ncdf4)
#source("geom_contourlabel.R")
source("helpfun.R")
```

\listoffigures
\newpage

\listoftables
\newpage

\section*{Agradecimientos}
\newpage

\section*{Resumen}
\newpage

# Introducción

La capa límite planetaria (CLP) corresponde a la porción de atmósfera que se encuentra directamente influenciada por la superficie y que responde a sus forzantes en una escala de tiempo de una hora o menos [@Stull1988]. Los procesos que ocurren dentro de esta capa son de suma importancia para entender y pronosticar la evolución de la atmósfera en distintas escalas espaciales y temporales. En particular estos procesos controlan el intercambio de energía entre la superficie y la atmósfera afectando, entre otras cosas, las condiciones para la ocurrencia de convección húmeda profunda y la intensidad de las circulaciones de mesoescala, que tienen un alto impacto sobre las actividades humanas.

En nuestra región existen estudios que buscan caracterizar los procesos que ocurren en la capa límite de forma tal de poder avanzar en su entendimiento y su dependencia por ejemplo con las propiedades de la superficie o el estado de la atmósfera [@Mazzeo1990; @Ulke2000; @Gassmann2001; @Acevedo2014; @Tonti2015].

Dado que la ocurrencia de turbulencia en la  capa límite planetaria se da en múltiples escalas espaciales y temporales, la representación de los procesos que ocurren dentro de ella es un desafío para los modelos numéricos. Actualmene los modelos de simulación regional y global no cuentan con la resolución necesaria para representar los procesos de la CLP de forma explícita, debiendo recurrir a una representación simplificada. De esta manera se simula numéricamente una parte del espectro turbulento, mientras que los procesos en la escala de subgrilla se resuelven a través de parametrizaciones con cierres de distinto orden, es decir, con diferentes niveles de aproximaciones. 

Existen diferentes alternativas para parametrizar los procesos de capa límite pero pueden clasificarse en dos grandes grupos. De acuerdo a @Stull1988, las parametrizaciones con clausura local determinan el valor de cualquier variable desconocida en cada punto a partir del valor o el gradiente de una variable conocida en el mismo punto; suponiendo que la turbulencia tiene un comportamiento análogo a la difusión molecular. Por otro lado las parametrizaciones con clausura no local asumen que la turbulencia está caracterizada por la superposición de torbellinos de distintas escalas que transportan las características del medio; y para lograr esto, el valor de la variable desconocida en un punto es aproximada a partir de una variable conocida en varios puntos en el espacio. 

La validación de las parametrizaciones de CLP en distintas situaciones sinópticas es un tema de gran interés debido a la necesidad de modelas los procesos de subgrilla presentes que afectan procesos en el resto de las escalas de variabiliad atmosférica [@Xie2012; @Banks2016]. 

A nivel regional, la representación de la capa límite en los modelos numéricos ha recibido mucha atención en las zonas oceánicas (particularmente en los océanos tropicales, @Wang2004). Sin embargo, existen pocos estudios acerca del desempeño de las parametrizaciones de capa límite en las regiones continentales [@Ulke2001; @Ruiz2010; @Berri2012; @Rizza2013].

Uno de los principales desafíos a la hora de estudiar los procesos que ocurren en la capa límite o para validar cómo los modelos representan dichos procesos, es la disponibilidad de observaciones. Las redes de radiosondeos que permiten obtener perfiles de viento, temperatura y humedad en la capa límite miden con frecuencias temporales de entre 12 y 24 horas (solo eventualmente cada 6 horas) lo que impide analizar la evolución de las características de la CLP a lo largo del día.

Sin embargo los radares Doppler permiten estimar la componente radial del viento en un radio horizontal de hasta 240 km y a partir de esa información permiten reconstruir perfiles verticales de viento utilizando la técnica Velocity Azimuth Display (VAD). 

En días en los que no existen ecos producidos por hidrometeoros, los radares pueden detectar la velocidad del viento dentro de la capa límite a partir de blancos como los insectos, de acuerdo a @Rennie2010 estos datos podrían ser utilizados si se elimina el efecto de los ecos de terreno y otras observaciones erroneas. Las observaciones de radar están disponibles con una frecuencia temporal de hasta 5 minutos permitiendo obtener perfiles de viento con una resolocuón temporal mucho mayor. 

La calidad de estos perfiles ha sido comparada con los perfiles obtenidos a partir de radiosondeos, encontrándose en general que los datos obtenidos resultan adecuados para su uso en el estudio de los procesos de capa límite y en la verificación de modelos numéricos [@Bousquet2008; @Salonen2008] y en la generación de condiciones iniciales para pronósticos a muy corto plazo [@Rennie2011].

Uno de los aspectos importantes a tener en cuenta en el uso de radares para el estudio de los perfiles de viento, es la necesidad de aplicar un riguroso control de calidad a los datos  que permita solucionar diversos aspectos que pueden afectar la confiabilidad de los mismo. Entre los problemas más comunes se cuentan: contaminación por ecos de terreno, efecto de aliasing, y contaminación por blancos móviles. Estos aspectos deben ser abordados antes de poder utilizar los datos para estimar el perfil de velocidad [@Holleman2008; @Rennie2011] aplicando algoritmos de control de calidad [@Ruiz2015; @Rennie2011].

La disponibilidad de la información de radar Doppler en Argentina ofrece un gran recurso de información para estudiar las propiedades de la capa límite planetaria en nuestra región y para validar la calidad de los modelos numéricos a la hora de representar dichas propiedades.

El objetivo de esta Tesis de Licenciatura es desarrollar una metodología para el estudio de los procesos de capa límite a partir de los datos de radar y analizar el comportamiento de distintas parametrizaciones de CLP disponibles en el modelo Weather Research and Forecasting (WRF - @Skamarock2008) al representar algunos de los procesos presentes a lo largo del día. 

Se plantea como hipótesis que los datos de viento radial obtenidos de información de radar permiten estimar los perfiles verticales de viento con una frecuencia temporal de 10 minutos, en un espesor que abarca desde superficie y hasta 2000 m de altura, permitiendo realizar una caracterización de la evolución temporal de dichos perfiles dentro de la capa límite atmosférica. La estimación de esos perfiles permitirán además validar las parametrizaciones de la capa límite que utilizan los modelos numéricos con una mayor resolución temporal a la utilizada en trabajos previos.

Para alcanzar el obejtivo se realizó el siguiente procedimiento: En primer lugar se determinaron las características necesarias para identificar posibles casos de estudio que permitan analizar los procesos de CLP asociados al ciclo diario. Luego se procesó los datos de radar para caso en estudio y se aplicaron los controles de calidad necesarios antes de realizar el cálculo del VAD desarrollado y validado como parte de este trabajo. Se analizó la consistencia de los resultados obtenidos y las características principales de la variación del viento a lo largo del día. Para las simulaciones numéricas con el modelo WRF se define un dominio y condiciones iniciales adecuadas para modelar un caso de estudio utilizando algunas parametrizaciones diponibles. Se comparan las simulaciones con las observaciones previamente obtenidas y se analizan algunas variables asociadas a la turbulencia. 

De esta manera, este trabajo permite desarrollar una metodología para el tratamiento de observaciones no convencionales, su aplicación al estudio de los procesos de CLP y al modelado numérico de los mismos.

# Metodología

En esta sección se describen los datos utilizados en el trabajo y las metodologías aplicadas al análisis.

## Región y casos de estudio

Este trabajo centra el análisis en la región de la ciudad de Paraná (provincia de Entre Ríos, Argentina) donde se encuentran el Radar Doppler del INTA (Instituto Nacional de Tecnología Agropecuaria) y una estación meterológica de superficie perteneciente al SMN (Servicio Meteorológico Nacional) separados por aproximadamete 9 kilometros de distancia.

```{r topografia, fig.cap="Topografía de la región en estudio en metros sobre el nivel del mar. El punto negro indica la ubicación del Radar INTA Paraná, el punto rojo indica la ubicación de la estación Paraná Aero. \\label{topografia}", fig.scap="Topografía de la región en estudio en metros sobre el nivel del mar."}

topo <- GetTopography(298.96, 299.95, -31.44, -32.25, resolution = 1/60, file.dir = "seudocache") %>% 
  .[, lon := ConvertLongitude(lon, from = 360)]

ggplot(topo, aes(lon, lat)) + 
  geom_contour_fill(aes(z = h)) +
  scale_fill_distiller(type = "seq", palette = "YlOrBr", 
                       name = "",
                       guide = guide_colorbar(title.position = "top", 
                                              title.hjust = 0.5)) +
  scale_x_continuous(name = "Longitud", limits = c(-61.04, -60.05), expand = c(0,0)) +
  scale_y_continuous(name = "Latitud", limits = c(-32.25, -31.44), expand = c(0,0)) +
  annotate(geom = "point", x = -60.537289, y = -31.848438, size = 2) +
  annotate(geom = "point", x = -60.483333, y = -31.783333, size = 2, color = "red") +
  coord_quickmap() + 
  theme_minimal() + theme(panel.ontop = T)

remove(topo)
```

La elevación de la región elegida muestra un mínimo de 5 metros sobre el nivel del mar en la cuenca del Río Paraná y un máximo de aproximadamente 110 metros sobre el nivel del mar sobre el margen sudeste de río donde ubica tanto la estación meteorológica como el radar (Figura \ref{topografia}). La región está dominada por la presencia del río y las regiones costeras donde predominan los campos de pastizales o pasto con excepción la ciudad de Paraná (al norte), la ciudad de Santa Fé (al noreste) y pequeños conglomerados de casas. 

### Criterios utilizados para la selección de los casos de estudio

Con el obejtivo analizar los procesos que ocurren en la CLP a lo largo del día es necesario identificar aquellas condiciones atmosféricas que permitan el desarrollo de la capa límite y al mismo tiene donde los datos de radar sean confliables. Por lo tanto se buscaron cumplir los siguientes criterios:

* Viento moderado. En estas situaciones los datos de radar son más confiables y permiten el desarrollo de la capa límite estable nocturna [@Gassmann2001].
* Cielos despejados. Para garantizar el calentamiento desde la superficie y el desarrollo de una capa límite mezclada.
* Verano. Donde el calentamiento es más intenso.

Las características previas se buscaron a partir del análisis de los datos de la estación meteorológica de superficie Paraná Aero provistos por el SMN y de reflextividad (dBZ) del radar de Paraná para los meses de enero de 2016 y 2017. 

En el primer tipo de datos se analizó la velocidad de viento, la cobertura nubosa y la precipitación observada a cada hora. En el caso de los datos de radar se observó la presencia de ecos meteorológicos en las inmediaciones del radar (a una distancia menor a 150 km) en cada tiempo disponible (aproximadamente cada 10 minutos). Un caso de estudio posible será aquel que cumpla con las características mencionadas durante las 24 horas del día aunque es deseable que las condiciones se mantengan durante las 12 horas previas al día en estudio ya que las características de la capa estable nocturna puede ser influenciada por las características de la capa mezcalda del día anterior.

### Descripción de los casos de estudio

A partir de análisis previamente descripto se identificaron 3 casos de estudio que se describen a continuación.

#### Caso 1: 14 de enero de 2016

El caso 1 abarca el perdiodo de las 00 UTC del 14 de enero a las 00 UTC del 15 de enero de 2016. A escala regional se observó un anticiclón ubicado sobre el oceano Atlántico y al este Uruguay a las 00 UTC de 14 de enero. Este sistema está asociado a vientos del noreste sobre el dominio en estudio. En superficie se registraron vientos débiles (menores a 2 m/s) del este y sureste en las primeras horas del periodo. En la estación meteorológica se observó nubosidad alta en las primeras horas de tipo cirroestrato que por momentos cortos cubrió el cielo. No se observaron ecos meteorológicos en la región del radar. **Que tanto afecta la nubosidad alta?**

Posteriormente, a las 12 UTC el anticiclón se intensifica y comienza a moverse hacia el NE y en superficie se observan vientos predominantes del noreste de hasta 6.5 m/s. No se observa nubosidad y la temperatura en superficie alcanza los 32.4°C.

**Humedad relativa disminuye de 85% a 35% en el periodo, no me queda clara la causa y tampoco se que tan importante puede ser esto luego**

## Descripción de los datos de radar

El radar ubicado en Paraná (Provincia de Entre Ríos) emite energía electromagnética en la banda C (4 a 8 GHz) y es de doble polarización.
La estrategia de escaneo de la atmósfera está programada para que la antena de giros en sentido horizontal de 360º y cambie de elevación sucesivamente 12 veces. El ángulo vertical varía entre 0.5° y 15.1°. El rango del radar (distancia a la que llega la señal desde la ubicación del radar) puede ser de 120, 240 y 480 km con una resolución espacial de 1 $\mathrm{km^2}$ [@Saibene2014] de acuerdo a la estrategía de escaneo.

El escaneo completo se realiza cada 10 minutos, dando 144 volumenes de datos
diarios registrando para las distintas variables como reflectividad (dBZ) y velocidad
radial ($V_r$).

En este trabajo se usaron datos de radar con un rango de 240 km y 12 ángulos de elevación para los periodos comprendidos por cada caso de estudios provistos por **XXXX INTA XXXX**

Cada volumen de dato correspondiente a un tiempo de escaneo completo fue convertido al formato CfRadial con el paquete Radx C++ desarrollado por Mike Dixon (NCAR - National Center for Atmospheric Research) **CITA** para el posterior procesamiento y análisis. 
En particular se utilizó la variable de reflectividad sin procesamiento para determinar la presencia o no de ecos meteorológicos en el dominio cercano al radar y la velocidad radial para la obtención de los perfiles de viento. 

## Tratamiento de aliassing

Un problema importante al momento de utilizar los datos de velocidad radial es la contaminación por aliasing ya que afecta significativamente la calidad de los perfiles de viento finales, de acuerdo a @Gao2004 un 3% de contaminación por aliassing puede generar un error cuadratico medio del 50% en el perfil de viento medio a partir de la técnica VAD. El aliasing es la superposición de la señal de radar y ocurre cuando la velocidad real supera a la velocidad de Nyquist ($V_N$). Este parámetro es intrínceco a las características del radar ya que depende de la frecuencia y estrategía de escaneo y en particular de la frecuencia de repetición del pulso o señal que emite.

En el caso del radar de Paraná con la estrategía de escaneo de 240km de rango, tiene una $V_N = 6.7 m/s$ por lo que cualquier velocidad mayor se verá afectada por el aliasing. Esto puede verse en la Figura \ref{aliasing}, las regiones con aliasing se son aquellas que donde el valor de la velocidad radial salta al extremo opuesto de la escala. 

Existen muchos algoritmos que buscan solucionar el problema del aliasing [por ejemplo @Lim2010 y @Haase2004] con distinto grado de exito. Una opción válida es el algoritmo de corrección de aliasing basado en regiones similares disponible en la librería PyART [@Helmus2016], este algoritmo busca regiones con velocidad radial similar y transforma el rango de la variable hasta que todas las regiones fueron corregidas de tal manera de obtener un campo continuo. El campo de velocidad radial sin aliasing obtenido utilizando este algoritmo se muestra en la Figura \ref{no-aliasing}. 

A partir de la exploración visual puede observarse que el algoritmo resuelve el problema de manera satisfactoria y por esta razón se utilizará para preprocesar todos los volumenes de datos de radar.

```{r aliasing, fig.cap="Velocidad radial (m/s) observada a las 06 UTC por el radar de Paraná en la elevación $1.3^{\\circ}$ y $V_N = 6.7 m/s$. Notar las escalas diferentes.", fig.subcap=c("Con aliasing \\label{aliasing}", "Sin aliasing \\label{no-aliasing}"), out.extra=" ", out.width="0.48\\textwidth"}

map <- setDT(fortify(rnaturalearth::ne_states(country = "Argentina"))) %>%
  .[, rango := range(long, lat)] %>% 
  .[, azimut := azimuth(long, lat)]

radar <- nc_open("seudocache/cfrad.20160114_060005.000_to_20160114_060431.001_INTA_Parana_SUR.nc")
azimut <- ncvar_get(radar, 'azimuth')   
elevacion <- ncvar_get(radar, 'elevation') 
rango <- ncvar_get(radar, 'range')      
V <- ncvar_get(radar, 'V')            
Vda <- ncvar_get(radar, 'Vda')
Vda[Vda > 99999] <- NA
elev <- unique(elevacion)

dimnames(V) <- list(rango = rango, azimut = azimut)
radar <- setDT(melt(V, value.name = "V")) 
radar[, elevacion := elevacion, by = rango]
radar[, Vda := c(Vda)]

radar[elevacion == elev[3] & !is.na(V), ] %>%
  RepeatLon(., colname = "azimut") %>% 
  ggplot(aes(azimut, rango/1000)) + 
  geom_path(data = map[rango <= 300*1000], aes(group = group), color = "darkgray") +
  geom_point(aes(color = V, size = rango)) +
  scale_color_divergent() +
  scale_size_area(max_size = 0.1) +
  scale_x_continuous(name = NULL, labels = NULL, breaks = seq(0, 359, 90)) +
  scale_y_continuous(name = "Distancia al centro (Km)", breaks = c(40, 120, 180, 240), 
                     limits = c(0, 300), expand = c(0, 0)) + 
  guides(size = "none") +
  coord_polar() +
  theme_minimal() + theme(legend.position = "bottom")

radar[elevacion == elev[3] & !is.na(Vda), ] %>%
  RepeatLon(., colname = "azimut") %>% 
  ggplot(aes(azimut, rango/1000)) + 
  geom_path(data = map[rango <= 300*1000], aes(group = group), color = "darkgray") +
  geom_point(aes(color = Vda, size = rango)) +
  scale_color_divergent(name = expression(V[da])) +
  scale_size_area(max_size = 0.1) +
  scale_x_continuous(name = NULL, labels = NULL, breaks = seq(0, 359, 90)) +
  scale_y_continuous(name = "Distancia al centro (Km)", breaks = c(40, 120, 180, 240), 
                     limits = c(0, 300), expand = c(0, 0)) + 
  guides(size = "none") +
  coord_polar() +
  theme_minimal() + theme(legend.position = "bottom")

#V.plot + Vda.plot
```


## Velocity Azimuth Display (VAD)

A medida que el radar rota en la dirección azimutal, mide la velocidad de los objetivos para cada ángulo y rango de manera continua y en función del azimut. A esto se le da el nombre de Visualización Azimutal de la Velocidad o por sus siglas en inglés VAD (por Velocity Azimuth Display, @Lhermitte1962) y se muestra en la Figura \ref{vad}. Puede observarse fácilmente que la velocidad radial media tiene un comportamiento sinusoidal. 

De esta manera, la velocidad radial medida por el radar corresponde a la velocidad de un objetivo u obstaculo en el camino del haz. En situaciones de aire claro (sin nubosidad) es posible tener una medida del campo de viento dentro de la capa límite usando insectos como obstaculos. Sin embargo esta velocidad no corresponde al campo de movimiento real ya que es medida en la dirección radial siendo los valores negativos movimiento hacia el radar y valores positivos movimientos desde el radar. Mientras que el valor nulo ocurre en las regiones donde la velocidad real es perpendicular a la trayectoria del haz.

A partir de este concepto distintos autores han desarrollado técnicas para obtener el perfil vertical de viento real a partir del viento radial o su gradiente con diferentes grados de complejidad que en la literatura. Estas técnicas son también son llamdas VAD (o sus derivaciones, @Browning1968; @Gao2004a; @Xu2011). Para esta tesis se desarrolló un algoritmo para el cálculo del VAD siguiendo a @Matejka1991 pero incluyendo controles de calidad específicos para asegurar la validez de los resultados.

#### Desarrollo matemático

El viento radial medido por el radar para un ángulo de elevación $\theta$ y rango $r$ determinado puede expresarse en función del azimuth $\phi$:

$$ V_r =  v \cos(\theta) \cos(\phi) + u \cos(\theta) \sin(\phi) - w \sin(\theta)$$

Donde $u$, $v$ y $w$ son las componentes del viento en coordenadas cartesianas.

El algoritmo ajusta los datos de cada anillo realizando una regreción lineal con la forma $V_r = a_0 + a_1\cos \phi + b_1 \sin \phi$ **Esto es una suma de series de fourier truncadas para i = 1**

Tambien se podría haber descompuesto $V_r$ en series de Fourier de orden superior para obtener otras características del viento. Pero por ahora nos quedamos con esto.
  

```{r vad, fig.cap="Velocidad radial (m/s) en función del azimut (grados) para un rango y ańgulo de elevación fijos. En color se  ajusta una función sinusoidal a los datos."}
ggplot(radar[rango %~% 4000 & elevacion == elev[3], ], aes(azimut, Vda)) +
  geom_line() +
  geom_smooth(method = "lm", formula = y ~ I(sin(x*pi/180)) + I(cos(x*pi/180)), se = F, color = "#20968b") +
  scale_y_continuous(name = "Velocidad radial (m/s)") +
  scale_x_continuous(name = "Azimut (grados)") +
  geom_hline(yintercept = 0) +
  theme_minimal()

```






#### Control de calidad y criterios

#### Validación

## Loess

## Detección del LLJ

## Tratamiento de la turbulencia

## Modelo de Oscilación Inercial

## WRF

### Parametrizaciones

# Resultados

## Análisis descriptivo de los casos
###caracteristicas generales y sinopticas
##Análisis de los VAD obtenidos
##Análisis de la turbulencia
##Análisis cualitativo de la oscilación inercial
##Analisis de las corridas y comparación con obs

# Conclusiones

# Referencias