---
title: "Prueba dBZ"
author: "Paola Corrales"
date: "January 15, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# librerías
library(metR)
library(ggplot2)
library(ggforce)
library(lubridate)
library(magrittr)
library(dplyr)
library(dtplyr)
library(viridis)
library(directlabels)
library(data.table)
library(patchwork)
library(ncdf4)
#source("geom_contourlabel.R")
source("helpfun.R")
```

```{r}
ReadRadar <- function(file) {
  radar <- nc_open(file)
  azimut <- ncvar_get(radar, 'azimuth')   
  elevacion <- ncvar_get(radar, 'elevation') 
  rango <- ncvar_get(radar, 'range')      
  # V <- ncvar_get(radar, 'V')            
  # Vda <- ncvar_get(radar, 'Vda')
  dbz <- ncvar_get(radar, 'dBZ')
  # Vda[Vda > 99999] <- NA
  datetime <- radar$dim$time$units %>% 
    strsplit(., "since") %>% 
    .[[1]] %>% 
    .[2] %>% 
    ymd_hms(tz = "UTC")
  second(datetime) <- 0
  dimnames(dbz) <- list(rango = rango, azimut = azimut)
  radar <- setDT(melt(dbz, value.name = "dbz")) 
  radar[, date := datetime]
  
  radar[, elevacion := elevacion, by = rango]
  R <- 6371.0*1000 #km
  Rp <- 4*R/3
  radar[, ht := sqrt((rango^2)+(Rp^2)+2*rango*Rp*sin(pi*elevacion/180))-Rp ]
  radar[elevacion < 6 & ht < 5000]
  radar
}

files <- Sys.glob("~/Radar/VAD/PARANA/20160114/Prueba/*.nc")
radar <- rbindlist(lapply(files, ReadRadar))

elev <- unique(radar$elevacion)
R <- 6371.0*1000 #km
Rp <- 4*R/3

radar[, ht := sqrt((rango^2)+(Rp^2)+2*rango*Rp*sin(pi*elevacion/180))-Rp ]


radar[elevacion == elev[3] & !is.na(dbz), ] %>%
  RepeatLon(., colname = "azimut") %>% 
  ggplot(aes(azimut, rango/1000)) + 
  geom_path(data = map[rango <= 300*1000], aes(group = group), color = "darkgray") +
  geom_point(aes(color = dbz, size = rango)) +
  #scale_color_divergent() +
  scale_size_area(max_size = 0.1) +
  scale_x_continuous(name = NULL, labels = NULL, breaks = seq(0, 359, 90)) +
  scale_y_continuous(name = "Distancia al centro (Km)", breaks = c(40, 120, 180, 240), 
                     limits = c(0, 300), expand = c(0, 0)) + 
  guides(size = "none") +
  coord_polar() +
  theme_minimal() + theme(legend.position = "bottom") +
  facet_wrap(~date)
```

```{r}
# Interpolo a una grilla regular

ht_reg <- seq(0, 10000, by = 100)
radar[, naN := sum(!is.na(dbz)), by = .(azimut, elevacion, date)]
reg <- radar[naN > 3, .(ht_reg = ht_reg,
                 dbz_reg = approx(ht, dbz, xout = ht_reg)$y), 
        by = .(azimut, elevacion, date)] %>% 
  .[elevacion < 6, mean(dbz_reg, na.rm = T), 
    by = .(ht_reg, date)] 

  ggplot(reg, aes(ht_reg, V1)) +
    #geom_line(aes(color = factor(elevacion))) +
    geom_line() +
    scale_color_viridis(name = "Elevación", discrete = T) +
    coord_flip() + 
    xlim(c(0,3500)) +
    scale_y_continuous(name = "dBZ") +
    facet_wrap(~date)
    
```
