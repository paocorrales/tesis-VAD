---
# title: "Tesis de Licenciatura"
author: "Paola Corrales"
date: ''
output:
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
    # toc: yes
    # toc_depth: 4
  word_document:
    reference_docx: word-template.docx
    # toc: yes
    # toc_depth: '4'
classoption: oneside, a4paper
documentclass: book
fontsize: 12pt
geometry: inner = 3cm, outer = 2cm, top = 2.5cm, bottom = 2.5cm
header-includes:
- \usepackage{setspace}
- \setstretch{1.5}
- \usepackage{subfig}
lang: es-AR
link-citation: yes
csl: Bibliografia/meteorologica.csl
subtitle: Validación de parametrizaciones de capa límite utilizando datos de radar
bibliography:
- Bibliografia/papers.bib
- Bibliografia/packages.bib
nocite: |
  @Amante2009, @Kalnay1996
---


```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE)

knitr::write_bib(c("base", "data.table", "ggplot2", "metR"),
                 file = "Bibliografia/packages.bib")
# librerías
library(metR)
library(ggplot2)
library(ggforce)
library(ggrepel)
library(lubridate)
library(magrittr)
library(dplyr)
library(dtplyr)
library(viridis)
library(directlabels)
library(data.table)
library(ncdf4)
library(knitr)
library(kableExtra)
library(circular)
source("helpfun.R")

# Variables útiles
mapa.ar <- setDT(fortify(rnaturalearth::ne_states(country = c("Argentina"))))
map2 <- setDT(fortify(rnaturalearth::ne_countries(country = c("Brazil", "Uruguay"))))
mapa.ar <- rbind(mapa.ar, map2) %>%
   .[, .(long = approx(.I, long, n = .N*5)$y,
         lat = approx(.I, lat, n = .N*5)$y),
     by = .(group)] %>%
   .[, rango := rrange(long, lat)] %>%
   .[, azimut := azimuth(long, lat)] %>%
   .[, group2 := cuad_split(azimut), by = group]

setnames(mapa.ar, "long", "lon")

mapa.sa <- setDT(fortify(rnaturalearth::ne_countries(continent = c("South America", "North America"))))
setnames(mapa.sa, "long", "lon")

mapa.rios <- setDT(fortify(rnaturalearth::ne_load(scale = 10, type = 'rivers_lake_centerlines', category = 'physical', destdir = "seudocache/")))
setnames(mapa.rios, "long", "lon")


text.height <- (297 - 50)/25.4
text.width <- (210 - 50)/25.4

color_manual <- c("#231151", "#d3436e", "#feba80")

path1 <- "~/Dropbox/Tesis/tesis-VAD/Tesis/"
path2 <- "/media/pao/Disk 2/VAD/"
remove(map2)
```



```{r leo-vad}

superficie <- setDT(read.sup(paste0(path1, "seudocache/superficie.csv")))
sup_vad <- convert.sup(superficie)

# Caso 1 - 14/01/2016
vad_20160114 <- read.vad(paste0(path2, "20160114/v*"))  
vad_20160114 <- rbind(subset(sup_vad,
                             day(date_time) == c(13,14)), vad_20160114)
vad_20160114[, caso := "Caso 1"]

remove(sup_vad)
```

## Análisis de las observaciones de radar procesadas con VAD

### Magnitud y velocidad del viento

Los datos de $V_r$ del radar fueron procesados para obtener la magnitud y la intensidad del viento para el período correspondiente a cada caso de estudio. Debido a que la señal de radar en días de aire claro no supera a los primeros kilómetros de atmósfera y que en altura los datos no superan los controles de calidad impuestos, en muchos momentos del día los perfiles se pueden estimar hasta una altura que varía entre 1000 y 3000 m.

La magnitud y dirección del viento para el Caso 1 se muestra en la Figura \ref{campo-caso1}. En la Figura \ref{caso1-spd} se puede observar en contornos la magnitud del viento en función de la altura y a lo largo del tiempo para todo el período correspondiente, y en símbolos los errores calculados. Las mayores velocidades de viento se observan en horas nocturnas con un máximo de 16 m/s cercano a las 06 UTC y a 300 metros de altura sobre la superficie. Este máximo comienza a observarse a partir de las 03 UTC y se extiende más allá de las 12 UTC (3 horas después de la salida del sol). Posteriormente, durante el día, la magnitud del viento disminuye a valores cercanos a 4 m/s y su variación con la altura es mucho menor en comparación con las horas previas. Estas características son coherentes con lo esperable en la capa mezclada. En las últimas horas del día la velocidad del viento comienza a aumentar nuevamente con valores de hasta 8 m/s coincidiendo con la puesta del sol cuando la capa mezclada queda desacoplada de la superficie y comienza a desarrollarse la capa límite estable nocturna.

En el período nocturno se observa un aumento en la magnitud de los errores, principalmente del $rmse$. Este error está asociado al error de estimación del viento en cada anillo de datos. Los mayores valores del $rmse$ (hasta 3.8 m/s) se observan en los bordes superior e inferior de las regiones donde hay datos, por lo que es posible que por fuera de estos límites los datos de radar no hayan cumplido con los controles de calidad y fueron descartados. La $dispersi\acute{o}n$ calculada para los datos, es menor a 0.5 m/s para la mayoría de los tiempos y altura. Algunas excepciones ocurren alrededor de las 08 UTC y para el mismo volumen de datos.

En la Figura \ref{caso1-dir} se muestra la dirección del viento en función de la altura y el tiempo, los vectores representan la dirección y sentido del viento, y en colores y largo de cada vector la magnitud. Se observa que en las primeras horas del Caso 1 la dirección predominante es del E y SE en niveles altos. En horas posteriores se observa una rotación mostrando vientos del NE durante el máximo nocturno. Durante el día el viento se mantiene con dirección N y NE. El nivel más bajo en el gráfico no corresponden a datos del radar sino al viento observado en la estación meteorológica. Si bien no se observa mucha coherencia entre los datos de superficie y lo observado por el radar para niveles cercanos a superficie, esto puede deberse al origen de los datos o diferencias en la ubicación geográfica.

```{r campo-caso1, fig.cap="Intensidad (m/s) y dirección del viento (grados) correspondiente al Caso 1 (14/01/2016) estimados a partir de las observaciones de radar utilizando la técnica VAD. En el caso de la magnitud del viento se muestran los errores calculados ($dispersi\\acute{o}n$ en círculos y $rmse$ en cruces) cuando superan los 0.5 m/s. \\label{campo-caso1}", fig.subcap=c("Magnitud del viento. \\label{caso1-spd}", "Dirección. \\label{caso1-dir}"), fig.width=0.95*text.width, fig.height=0.4*text.height, fig.ncol=1}

vad_20160114[ht > 0.02] %>%
  ggplot(aes(date_time, ht)) +
  geom_contour(aes(z = spd_smooth, color = ..level..), binwidth = 1) +
  scale_color_viridis(name = "Magnitud\ndel viento", direction = 1,
                      breaks = seq(0, 16, 2), limits = c(0, 16),
                      guide = guide_colorbar(order = 1)) +
  geom_point(data = subset(vad_20160114, rmse1 > 0.5),
             aes(size = rmse1),
             shape = 1, color = "grey25") +
  geom_point(data = subset(vad_20160114, rmse2 > 0.5),
             aes(size = rmse2),
             shape = 4, color = "grey25") +
  geom_label_contour2(aes(z = spd_smooth, label = ..level.., color = ..level..),
                    size = 4,
                    breaks = seq(0, 16, 1)) +
  scale_size(name = "Error", guide = guide_legend(order = 2)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-13 00:00:00"), NA),
                   expand = c(0,0)) +
  scale_y_continuous(name = "Altura (km)", limits = c(0,NA),
                     expand = c(0,0)) +
  theme_minimal()

vad_20160114[minute(date_time) == 0 & !is.na(spd_smooth)] %>%
  ggplot(aes(date_time, ht)) +
  geom_arrow(aes(mag = spd_smooth, angle = di, color = spd_smooth),
             scale = 0.007, start = -90, direction = -1) +
  # geom_point(data = subset(vad_20160114, rmse1 > 0.5),
  #            aes(size = rmse1),
  #            shape = 1, color = "grey25") +
  # geom_point(data = subset(vad_20160114, rmse2 > 0.5),
  #            aes(size = rmse2),
  #            shape = 4, color = "grey25") +
  scale_color_viridis(name = "Magnitud\ndel viento",
                      breaks = seq(0, 16, 2), limits = c(0, 16)) +
  scale_size_continuous(range = c(0, 5), guide = "none") +
  scale_y_continuous(name = "Altura (km)", limits = c(0,NA)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-13 00:00:00"), NA)) +
  theme_minimal()
```


```{r perfiles, fig.cap="Perfil vertical de viento (m/s) estimado a partir de los datos de radar a las 06 y las 17 UTC y el $rmse$ (m/s) en cada punto (sombreado) para los tres casos. Las marcas en los ejes indican la magnitud del viento máxima y mínima (por encima del LLJ) y la altura a la que ocurren. Los valores en superficie fueron obtenidos a partir de los datos del la estación meteorológica Paraná Aero. \\label{perfiles-horarios}", fig.width=0.95*text.width, fig.align='center'}

gdata <- vad_20160114%>%
  .[minute(date_time) == 00 & hour(date_time) %in% c(06, 17) & ht < 2.5 &
      !is.na(spd_smooth)]
ggplot(gdata, aes(ht, spd_smooth, color = as.factor(hour(date_time)))) +
  geom_line() +
  geom_rug(data = gdata[minute(date_time) == 00 & hour(date_time) == 6][, maxspd := max(spd_smooth, na.rm = T), by = caso][spd_smooth == maxspd]) +
  geom_rug(data = gdata[minute(date_time) == 00 & hour(date_time) == 6 & ht > 0.5][, minspd := min(spd_smooth, na.rm = T), by = caso][spd_smooth == minspd]) +
  geom_ribbon(aes(ymin = spd_smooth - rmse2, ymax = spd_smooth + rmse2,
              fill = as.factor(hour(date_time))),
              alpha = 0.5, color = NA) +
  coord_flip() +
  scale_color_manual(name="Hora UTC", values = color_manual) +
  scale_fill_manual(name="Hora UTC", values = color_manual) +
  scale_y_continuous(name = "V (m/s)") +
  scale_x_continuous(name = "Altura (km)", breaks = seq(0, 2.5, 0.5),
                     limits = c(0, 2.5)) +
  facet_wrap(~caso+day(date_time)) +
  theme_minimal()
```

La variación de la dirección del viento con la altura puede analizarse a partir de un hodógrafa. En la Figura \ref{hodografa-h} se muestra la hodógrafa de las 06 UTC para cada caso. El triángulo corresponde al nivel inferior y los círculos grandes se ubican cada 500 m. Se observa en los tres casos una rotación antihoraria en los primeros metros (correspondientes a la capa límite estable nocturna), que se mantiene en todo el perfil para los casos 2 y 3. Esto podría deberse a que los perfiles mantienen algunas características propias de la capa mezclada del día anterior a pesar del decaimiento de la turbulencia y el desarrollo de la capa estable. Si bien existen discusiones sobre la validés del modelo, estás características podrían estar asociadas a la espiral de Ekman con rotación del viento en sentido antihorario [@Stull1988].

```{r hodografa-horaria, fig.cap="Hodógrafa en función de la altura entre 100 y 3000 metros, para cada caso de estudio observada por el radar a las 06 UTC. El triángulo marca el nivel inferior y los círculos grandes se ubican cada 500 metros. \\label{hodografa-h}", fig.align='center', fig.width=0.75*text.width}

gdata <- rbind(vad_20160114, vad_20160121, vad_20160123) %>%
  .[, hora := hour(date_time)] %>%
  .[minute(date_time) == 00 & hour(date_time) %in% c(06) &
      !is.na(spd_smooth) & ht > 0.02 & ht <= 3]
ggplot(gdata, aes(u, v,  color = caso)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "darkgrey") +
  geom_point(data=subset(gdata, ht != 0.1), size = 1) +
  geom_point(aes(x = ifelse(ht %in% seq(0.1, 3.0, 0.5), u, NA)),
             size = 2) +
  geom_point(data=subset(gdata, ht == 0.1), shape = 17, size = 3) +
  geom_path() +
  scale_color_viridis(name="Casos", discrete = T) +
  scale_x_continuous(name = "u (m/s)") +
  scale_y_continuous(name = "v (m/s)") +
 # facet_wrap(~hora, scales = "free") +
  coord_equal() +
  theme_minimal()
```
### Características de la capa límite planetaria

#### Oscilación inercial y LLJ

Si bien en los perfiles mostrados en la Figura \ref{perfiles-horarios} se observa claramente las características típicas del LLJ con el máximo viento en los primeros cientos de metros, el criterio de Bonner permite detectar el LLJ de manera cuantitativa. De acuerdo al Criterio 1 el LLJ ocurre si el máximo de viento es igual o superior a 12 m/s y disminuye al menos 6 m/s al alcanzar el siguiente mínimo [@Bonner1968]. Valores análogos se siguen para máximos de mayor magnitud, por ejemplo si el máximo es de 16 m/s, el mínimo tendrá que ser de al menos 8 m/s (Criterio 2). Esto también puede verse en la Figura \ref{perfiles-horarios} observando la diferencia entre las marcas verticales en el eje horizontal que representan el mínimo y el máximo en cada perfil nocturno. En todos los casos en estudio el criterio de Bonner se cumple satisfactoriamente.

En la Figura \ref{hodografa-n} se muestran hodógrafas temporales para tres niveles distintos (el primero correspondiente a las observaciones de la estación meteorológica) desde las 00 UTC. El cuadrado indica el punto final del vector del viento en el primer tiempo y los círculos grandes, corresponden al vector en intervalos cada 6 horas. De acuerdo al modelo de @VanDeWiel2010, en los niveles próximos a la superficie el giro de la hodógrafa es antihorario (en el Hemisferio Sur) con respecto al vector de viento inicial. Esta osicilación genera la disminución de la magnitud del viento ya que hacia la puesta de sol, la velocidad del viento cerca de superficie es mayor que la velocidad asociada al perfil de equilibrio nocturno que resulta del balance entre la fuerza de presión, Coriolis y el transporte turbulento de cantidad de movimiento que continúa actuando durante la noche en esta porción de la atmósfera. En niveles altos, el giro del viento se mantienen antihorario pero la oscilación produce un aumento de la magnitud del viento, debido a que el viento a la hora del atardecer es menor que el perfil de equilibrio nocturno que es aproximadamente igual al viento geostrófico. Esto es debido principalmente a que en estos niveles el efecto de la turbulencia es mucho menor o nulo respecto de lo que ocurría durante las horas diurnas. Por las características de los datos registrados por la estación meteorológica, en la hodógrafa correspondiente al nivel inferior no hay evidencias de una rotacion coherente de la dirección del viento con el tiempo como se esperaría a partir del modelo de oscilación inercial (Figura \ref{hodo-nivel1}).

Por su parte los perfiles estimados a partir del radar entre las 00 y las 09 UTC muestran que en los niveles superiores 0.3 km dentro de la capa estable) y 1 km (por encima de la capa estable) la forma de herradura si puede distinguirse y el giro de la hodógrafa es antihorario mostrando una concordancia cualitativa con el modelo de oscilación inercial propuesto por Van de Wiel. Posterior a las 09 UTC, comienza a formarse la capa mezclada a partir de la producción de turbulencia térmica y por lo tanto el comportamiento del viento depende de procesos distintos a oscilación inercial dejando de ser válido el modelo de Van de Wiel. Si bien cada caso tiene sus características particulares, los casos 1 y 2 tienen cierta similitud ya que las hodógrafas se ubican principalmente en el cuadrante inferior izquierdo mientras que la hodógrafa del Caso 3 se ubica en el derecho. Esto último tiene que ver con las características del viento que es predominante del O en casi todo el período para este último caso.

Las hodógrafas observadas para los dos niveles mostrados (y otros niveles no incluidos en la figura por motivos de espacio) muestran una variación con la altura principalmente en la magnitud del viento. Esto indica que la oscilación inercial tiene una variación vertical y podría estar asociada al perfil inicial del viento geostrófico al atardecer [@Blackadar1957].

```{r hodografa-nivel, fig.cap="Hodógrafa temporal para el nivel correspondiente a los datos de la estación meteorológica (a) y 0.3 y 1 km a partir de la estimación del viento con los dato del radar (b). el cuadrado marca el primer tiempo (00 UTC) y cada círculo representa un valor horario (con circulos más grandes cada 6 horas). \\label{hodografa-n}", fig.subcap=c("Datos observados en la estación meteorológica. \\label{hodo-nivel1}", "Datos observados por el radar. \\label{hodo-nivel2}"), fig.width=0.95*text.width, fig.ncol=1, fig.align='center', fig.height=0.25*text.height}

gdata <- rbind(vad_20160114, vad_20160121, vad_20160123)
gdata <- as.data.table(gdata) %>%
  .[, hora := hour(date_time)] %>%
  .[ht %in% c(0.01) & !is.na(spd_smooth) &
      minute(date_time) == 00 & hora < 18]
ggplot(gdata, aes(u, v,  color = as.factor(ht))) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "darkgrey") +
  geom_point(aes(x = ifelse(hour(date_time) != 0, u, NA)), size = 1) +
  geom_point(aes(x = ifelse(hour(date_time) %in% c(0,6,12), u, NA)),
             size = 2) +
  geom_point(aes(x = ifelse(hour(date_time) == 0, u, NA)), shape = 15,
             size = 3) +
  geom_path() +
  geom_text_repel(aes(label = JumpBy(hora, 6, fill = NA)),
                  data = gdata[ht != 1]) +
  scale_color_manual(name="Altura", values = c("#231151", "#d3436e", "#feba80")) +
  scale_x_continuous(name = "u (m/s)") +
  scale_y_continuous(name = "v (m/s)") +
  coord_equal() +
  facet_wrap(~caso) +
  theme_minimal()

gdata <- as.data.table(rbind(vad_20160114, vad_20160121, vad_20160123)) %>%
  .[, hora := hour(date_time)] %>%
  .[ht %in% c(0.3, 1) & !is.na(spd_smooth) &
      minute(date_time) == 00 & hora <= 18]
ggplot(gdata, aes(u, v,  color = as.factor(ht))) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "darkgrey") +
  geom_point(aes(x = ifelse(hour(date_time) != 0, u, NA)), size = 1) +
  geom_point(aes(x = ifelse(hour(date_time) %in% c(0,6,12), u, NA)),
             size = 2) +
  geom_point(aes(x = ifelse(hour(date_time) == 0, u, NA)), shape = 15,
             size = 3) +
  geom_path() +
  geom_text_repel(aes(label = JumpBy(hora, 6, fill = NA)),
                  data = gdata[ht != 1]) +
  scale_color_manual(name="Altura", values = c("#d3436e", "#feba80")) +
  scale_x_continuous(name = "u (m/s)") +
  scale_y_continuous(name = "v (m/s)") +
  coord_equal() +
  facet_wrap(~caso) +
  theme_minimal()

```


#### Altura de la capa límite y turbulencia

```{r read-dbz}
files <- Sys.glob("~/Radar/VAD/PARANA/20160114/240/*.nc")
dbz_20160114 <- rbindlist(lapply(files, read.radar))

files <- Sys.glob("~/Radar/VAD/PARANA/20160121/240/*.nc")
dbz_20160121 <- rbindlist(lapply(files, read.radar))

files <- Sys.glob("~/Radar/VAD/PARANA/20160123/240/*.nc")
dbz_20160123 <- rbindlist(lapply(files, read.radar))
```


Una posible manera de determinar la altura de la capa límite es analizando la distribución de los ecos de reflectividad detectados por el radar a lo largo del día. En días de aire claro las variaciones de la reflectividad pueden depender tanto de la presencia de insectos dentro de la capa límite como de la variaciones del índice de refracción del aire producto de la turbulencia observada o "Bragg scatter" [@Martin2007]. La turbulencia modifica el índice de refracción del aire y produce un aumento en la variación de la reflectividad con la altura. En la Figura \ref{dbz} se muestra la reflectividad medida por el radar en función de la altura y el tiempo para cada caso de estudio mientras que en la Figura \ref{pblh-dbz} se muestra el valor absoluto del gradiente vertical de reflectividad ($\nabla_z dBZ$) para los mismos períodos. Debido a que se buscan las mayores variaciones de reflectividad en la Figura \ref{pblh-dbz} se buscó resaltar los niveles donde el gradiente vertical de reflectividad fuera mayor independientemente del signo. Luego de la exploración de los datos se decidió utilizar sólo los datos del ángulo de 5° de elevación, con excepción de los primeros niveles, por tener poco ruido y presentar cierta coherencia espacial.

En el Caso 1 (Figura \ref{reflec-1}) la reflectividad muestra valores positivos y máximos en niveles cercanos a la superficie que forman una región entre 5 y 10 dBZ por encima de la cual la variable disminuye hasta alcanzar valores negativos. En la Figura \ref{dbz-1} se observa un máximo del $\nabla_z dBZ$ a aproximadamente 300 m de altura entre las 03 y 09 UTC que luego se eleva rápidamente y forma dos máximos, uno a 1000 m hasta las 15 UTC y el otro por encima hasta las 18 UTC, que luego decae hasta desaparecer a partir de las 21 UTC. Estos máximos coinciden con la ubicación de los máximos de dBZ y la región límite por encima de la cual la variable es negativa. Por las características del crecimiento, entre las 09 y las 11 UTC, el tope de la capa límite mezclada correspondería al segundo máximo, ya que también se observa en los perfiles verticales de viento (Figura \ref{perfiles-horarios}) que la capa mezclada alcanza los 2 km de altura. El primer máximo de gradiente que ocurre entre las 10 y las 15 UTC a 1000 m de altura coincide con el borde superior del LLJ, que va perdiendo intensidad luego del amanecer pero que mantiene una cortante de viento importante y que podría generar un aumento de la reflectividad debido al Bragg scattering por la presencia de turbulencia mecánica. También podría estar relacionado con ecos asociados a la presencia de insectos. También se observa un mínimo de reflectividad entre dos máximos, uno de ellos cerca de superficie y el otro a 1000 m de altura entre las 09 y las 12 UTC que podrían estar asociados a la cortante que se produce por debajo de jet. En las observaciones entre las 00 y 09 UTC se observan regiones con máximos relativos de $\nabla_z dBZ$ que podría estar asociado la presencia de la capa residual y la turbulencia remanente de la capa mezclada del día anterior. De acuerdo a @Martin2007 el aumento de la reflectividad observado en esas horas podría deberse a la presencia de insectos que tienen mayor actividad luego del atardecer, esta característica es llamada "bloom del radar".

En la Figura \ref{reflec-2} la reflectividad para el Caso 2 muestra regiones donde la variable es positiva y máxima pero la estructura no es tan clara como ocurre en el Caso 1. De la misma manera, en la Figura \ref{dbz-2} las regiones de máximo  $\nabla_z dBZ$ no son claras aunque es posible determinar una línea entre 500 y 1000 m previo a las 09 UTC que podría corresponder al tope de la capa límite estable nocturna. Luego de ese momento, el máximo del gradiente vertical aumenta rápidamente hasta alcanzar los 1500 m de altura y comienza a descender luego de las 12 UTC. Estas observaciones no concuerdan con el perfil vertical de viento observado a las 17 UTC (Figura \ref{perfiles-horarios}) que se mantiene homogéneo alcanzando una altura de 2000 m.

La variación de la reflectividad con la altura para el Caso 3 se muestra en la Figura \ref{reflec-3}, si bien la región de valores positivos ocupa gran parte del espesor de atmósfera mostrado, es evidente un máximo absoluto por debajo de 500 m que luego de las 09 UTC asciende por encima de los 1000 m. La variación de $\nabla_z dBZ$ con la altura (Figura \ref{dbz-3}) muestra un máximo cercano a 2000 m en las primeras horas de la noche que luego desciende y podría corresponder nuevamente al "bloom del radar". Por otro lado se observa por debajo de 500 m un máximo intenso que se mantiene durante horas hasta las 14 UTC. Durante la noche este máximo puede asociarse al tope de la capa estable pero luego del amanecer la persistencia de esta capa de gran variabilidad en la reflectividad podría deberse a la presencia de turbulencia debido a la cortante vertical de viento generada por el máximo de viento secundario que se observa en la Figura \ref{caso3-spd} a las 12 UTC. Al igual que en los otros casos se observa un máximo relativo que crece desde las 9 UTC y alcanza rápidamente los 2000 m de altura. Este máximo que se mantiene durante el día podría indicar el tope de la capa mezclada.

```{r dbz, fig.cap="Reflecttividad (dBZ) medida por el radar en función de la altura y el tiempo para el Caso 1 (a), el Caso 2 (b) y el Caso 3 (c). \\label{dbz}", fig.subcap=c("Caso 1. \\label{reflec-1}", "Caso2. \\label{reflec-2}", "Caso 3. \\label{reflec-3}"), fig.align='center', fig.height=0.28*text.height, fig.ncol=1}
elev <- unique(dbz_20160114$elevacion)
dbz_20160114[elevacion == elev[8] & ht_reg > 100] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = dbz, color = dbz)) +
  scale_fill_viridis(name = "dBZ",
               limits = c(NA, NA)) +
  scale_color_viridis(name = "dBZ",
                    limits = c(NA, NA)) +
  # geom_contour(data = vad_20160114[ht > 0.02], aes(date_time, ht, z = spd_smooth)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                     expand = c(0,0)) +
  scale_x_datetime(name = NULL,
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()

dbz_20160121[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = dbz, color = dbz)) +
  scale_fill_viridis(name = "dBZ",
               limits = c(NA, NA)) +
  scale_color_viridis(name = "dBZ",
                    limits = c(NA, NA)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                     expand = c(0,0)) +
  scale_x_datetime(name = NULL,
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-21 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()

dbz_20160123[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = dbz, color = dbz)) +
  scale_fill_viridis(name = "dBZ",
               limits = c(NA, NA)) +
  scale_color_viridis(name = "dBZ",
                    limits = c(NA, NA)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                     expand = c(0,0)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-23 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()

```

```{r pblh-dbz, fig.cap="Valor absoluto del gradiente vertical de reflectividad (dBZ/m) en función de la altura y el tiempo para el Caso 1 (a), el Caso 2 (b) y el Caso 3 (c). \\label{pblh-dbz}", fig.subcap=c("Caso 1. \\label{dbz-1}", "Caso2. \\label{dbz-2}", "Caso 3. \\label{dbz-3}"), fig.align='center', fig.height=0.28*text.height, fig.ncol=1}
elev <- unique(dbz_20160114$elevacion)
dbz_20160114[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = abs(ddbz), color = abs(ddbz))) +
  scale_fill_viridis(name = "Gradiente \n vertical de \n reflectividad",
                     limits = c(0, 0.06)) +
  scale_color_viridis(name = "Gradiente \n vertical de \n reflectividad",
                      limits = c(0, 0.06)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                     expand = c(0,0)) +
  scale_x_datetime(name = NULL,
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()

dbz_20160121[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = abs(ddbz), color = abs(ddbz))) +
  scale_fill_viridis(name = "Gradiente \n vertical de \n reflectividad",
                     limits = c(0, 0.06)) +
  scale_color_viridis(name = "Gradiente \n vertical de \n reflectividad",
                      limits = c(0, 0.06)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                    expand = c(0,0)) +
  scale_x_datetime(name = NULL,
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-21 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()

dbz_20160123[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  #geom_line(aes(color = factor(elevacion))) +
  geom_tile(aes(fill = abs(ddbz), color = abs(ddbz))) +
  scale_fill_viridis(name = "Gradiente \n vertical de \n reflectividad",
                     limits = c(0, 0.06)) +
  scale_color_viridis(name = "Gradiente \n vertical de \n reflectividad",
                      limits = c(0, 0.06)) +
  scale_y_continuous(name = "Altura (km)",
                     limits = c(0, 3),
                     breaks = seq(0, 3, 0.5),
                    expand = c(0,0)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-23 00:00:00"), NA),
                   expand = c(0,0)) +
  theme_minimal()
remove(dbz_20160121, dbz_20160123)

```


```{r make-ri}
sup_20160114 <- superficie[day(fecha) == 14]
ri_20160114 <- create.ri(vad_20160114, sup_20160114$fecha, sup_20160114$temp, sup_20160114$presion_estacion, 27.7, 1002.6)
ri_20160114[, caso := "Caso 1"]

sup_20160121 <- superficie[day(fecha) == 21]
ri_20160121 <- create.ri(vad_20160121, sup_20160121$fecha, sup_20160121$temp, sup_20160121$presion_estacion, 35.7, 1001.8)
ri_20160121[, caso := "Caso 2"]

sup_20160123 <- superficie[day(fecha) == 23]
ri_20160123 <- create.ri(vad_20160123, sup_20160123$fecha, sup_20160123$temp, sup_20160123$presion_estacion, 34.2, 998.8)
ri_20160123[, caso := "Caso 3"]

ri_vad <- rbindlist(list(ri_20160114, ri_20160121, ri_20160123))
ri_vad[, hora := day(date_time)]

remove(sup_20160114, sup_20160121, sup_20160123,
            ri_20160114, ri_20160121, ri_20160123)
```

La estimación del tope de la capa límite a partir de las variaciones de la reflectividad con la altura es una metodología poco desarrollada y que no ha sido aplicada a la información provista por los radares de la región. Por este motivo es importante contar con estimaciones independientes para validar los resultados previos. Los datos disponibles en este trabajo permitieron evaluar algunas características de la capa estable nocturna (Figura \ref{estable-vad}). En primer lugar se estimó la altura de la capa estable como el nivel en el cual ocurre el máximo viento (Figura \ref{h-vad}) durante el período donde se observó el máximo. Esta estimación depende de la resolución vertical elegida para el cálculo del VAD que en este caso es de 100 m, por lo tanto la estimación no es muy precisa. En la Figura \ref{cortante-vad} se presenta la cortante vertical calculada por debajo del máximo del viento y en la Figura \ref{ri-vad} el número de Richardson calculado de acuerdo a la Ecuación \ref{eq-ri3} hasta la hora del amanecer cuando la aproximación deja de ser válida. Los períodos sombreados corresponden a los momentos donde se observó el máximo de viento.

En el Caso 1 la altura de la capa estable se mantuvo en 300 m en todo momento coincidiendo con lo estimado a partir del $\nabla_z dBZ$. La cortante de viento tuvo variaciones temporales con un máximo que coincidió con el momento donde el LLJ fue más intenso. De acuerdo a @Banta2003, estos valores de cortante están asociados a la presencia de energía cinética turbulenta y podría ser usada como un estimado de la turbulencia en la capa. Consistente con lo anterior, el número de Richardson es siempre positivo y por lo tanto se trata de una situación de estabilidad estática y además se mantiene por debajo de 1 por lo tanto el flujo se mantiene turbulento debido a procesos mecánicos asociados a la cortante.

En los Casos 2 y 3 la cortante vertical y el número de Richardson tienen un comportamiento similar al primer caso y por lo tanto corresponden a situaciones estables con el flujo en estado turbulento.

La estimación del tope de la capa estable en el Caso 2 de acuerdo a este criterio se ubica en 200 m. En este caso es muy difícil establecer una comparación con lo visualizado en la Figura \ref{dbz-2}, ya que los ecos de radar ofrecen muy poca intensidad de los máximos relativos cercanos a superficie, impidiendo delimitar bien la posición del tope de la capa límite estable nocturna con esa metodología. En el Caso 3 las dos estimaciones si coinciden y además se observa coincidencia en la evolución a lo largo del tiempo.

```{r estable-vad, fig.cap="Series de tiempo de la altura de la capa límite, cortante vertical y el número de Richarsdon en la capa estable nocturna para todos los casos de estudio. En a) y b) se muestra solo el período donde se observa el LLJ, en c) el período en cada caso se encuentra sombreado. \\label{estable-vad}", fig.subcap=c("Altura de la capa estable \\label{h-vad}", "Cortante ($u_{máx}/z_{máx}$) \\label{cortante-vad}", "Número de Richardson \\label{ri-vad}"), fig.ncol=1, fig.height=0.24*text.height}

ri_vad$hora <- ri_vad$date_time
day(ri_vad$hora) = 14
lim <- as.POSIXct(c(as_datetime("2016-01-14 00:00:00"), as_datetime("2016-01-14 12:00:00")))

ri_vad[hour(hora) %between% c(0, 12)] %>%
  .[(caso == "Caso 1" & hora %between% c(as_datetime("2016-01-14 03:50:00"), as_datetime("2016-01-14 09:40:00"))) |
    (caso == "Caso 2" & hora %between% c(as_datetime("2016-01-14 04:00:00"), as_datetime("2016-01-14 10:50:00"))) |
    (caso == "Caso 3" & hora %between% c(as_datetime("2016-01-14 02:00:00"), as_datetime("2016-01-14 09:30:00")))] %>%
  ggplot(aes(hora, z_max)) +
  geom_line(aes(color = caso)) +
  scale_color_viridis(name = "Casos", discrete = T) +
  scale_y_continuous(name = "h (km)") +
  scale_x_datetime(name = NULL, limits = lim) +
  coord_cartesian(ylim = c(0, 0.8)) +
  theme_minimal()

ri_vad[hour(hora) %between% c(0, 12)] %>%
  .[(caso == "Caso 1" & hora %between% c(as_datetime("2016-01-14 03:50:00"), as_datetime("2016-01-14 09:40:00"))) |
    (caso == "Caso 2" & hora %between% c(as_datetime("2016-01-14 04:00:00"), as_datetime("2016-01-14 10:50:00"))) |
    (caso == "Caso 3" & hora %between% c(as_datetime("2016-01-14 02:00:00"), as_datetime("2016-01-14 09:30:00")))] %>%
  ggplot(aes(hora, u_max/(z_max*1000))) +
  geom_line(aes(color = caso)) +
  scale_color_viridis(name = "Casos", discrete = T) +
  scale_y_continuous(name = expression(paste(u[máx]/z[max], " (1/s)"))) +
  scale_x_datetime(name = NULL, limits = lim) +
  theme_minimal()

ri_vad[hour(hora) %between% c(0, 12)] %>%
  ggplot(aes(hora, ri)) +
  annotate(geom = "rect",
           xmin = as_datetime("2016-01-14 03:50:00"),
           xmax = as_datetime("2016-01-14 09:00:00"),
           ymin = -Inf, ymax = Inf,
           color = "#440154",
           fill = "#440154", alpha = 0.1) +
  annotate(geom = "rect", xmin = as_datetime("2016-01-14 04:00:00"),
           xmax = as_datetime("2016-01-14 09:00:00"),
           ymin = -Inf, ymax = Inf,
           color = "#21908c",
           fill = "#21908c", alpha = 0.1) +
  annotate(geom = "rect", xmin = as_datetime("2016-01-14 02:00:00"),
           xmax = as_datetime("2016-01-14 09:00:00"),
           ymin = -Inf, ymax = Inf,
           color = "#fde725",
           fill = "#fde725", alpha = 0.1) +
  geom_point(aes(color = caso)) +
  scale_color_viridis(name = "Casos", discrete = T) +
  geom_hline(yintercept = 1, color = "darkgray") +
  scale_y_continuous(name = "Ri") +
  scale_x_datetime(name = "Hora UTC", limits = as.POSIXct(c(as_datetime("2016-01-14 00:00:00"), as_datetime("2016-01-14 09:00:00")))) +
  theme_minimal()

remove(gdata, vad_20160121, vad_20160123)
```


##Análisis de las simulaciones con WRF y comparación con observaciones de radar

Se realizaron tres simulaciones para el período correspondiente al Caso 1 utilizando distintas parametrizaciones de capa límite. Para analizar el desempeño de las parametrizaciones elegidas se compararon las distintas simulaciones con las observaciones de radar y se calcularon la diferencias en la magnitud del viento, el ángulo de la dirección del viento y algunos parámetros como el bias  (o sesgo), rmse, rmsens (raíz del error cuadrático medio debido a errores no sistemáticos) y el coeficiente de correlación tanto globalmente como dependientes de la altura.

### Magnitud y dirección del viento

```{r read-WRF-VAD}
# YSU
vad_caso1ysu <- read.vad("../../caso1ysu_240/vda*")
vad_caso1ysu[, caso := "YSU"]

#MYJ
vad_caso1myj <- read.vad("../../caso1myj_240/vda*")
vad_caso1myj[, caso := "MYJ"]

#ACM2
vad_caso1acm <- read.vad("../../caso1acm_240/vda*")
vad_caso1acm[, caso := "ACM2"]

vad_20160114 <- vad_20160114[, caso := "Obs"]
```

En la Figura \ref{modelo-spd} se  muestra la magnitud del viento en función del tiempo y de la altura observada por el radar (panel superior izquierdo) y cada simulación nombradas de acuerdo a la parametrización de capa límite utilizada: YSU, MYJ y ACM2. En términos generales se puede observar en primer lugar que las tres simulaciones son similares entre sí y en segundo lugar que hay una coherencia importante entre las simulaciones y las observaciones ya que las simulaciones son capaces de representar el máximo de viento nocturno asociado al LLJ y el viento más débil y verticalmente homogéneo en las horas diurnas.

Sin embargo hay diferencias destacables entre las observaciones y las simulaciones. Se observa un primer máximo entre las 00 y las 03 UTC por debajo de 500 m en las primeras horas que precede al máximo asociado al LLJ pero que tiene menor magnitud. Si bien no hay observaciones previas a las 00 UTC, las tres simulaciones coinciden en mostrar un aumento en la intensidad del viento en la capa mezclada a partir de las 22 UTC, una hora antes del atardecer. Posteriormente en las tres simulaciones el LLJ parece prolongarse en el tiempo al menos 3 horas más que en las observaciones y el máximo de viento ocurre en distintos niveles en cada caso. En niveles altos, durante la noche el viento decrece rápidamente  subestimando los valores observados.


```{r vad-modelo-spd, fig.cap="Magnitud del viento (m/s) estimada a partir de los datos de radar (Obs) y simulada por el modelo WRF utilizando distintos esquemas de CLP para el Caso 1 (14/01/2016) y posteriormente procesados con la técnica VAD. \\label{modelo-spd}", fig.width=0.98*text.width, fig.align='center'}

gdata <- setDT(rbind(vad_20160114, vad_caso1ysu, vad_caso1myj, vad_caso1acm))
gdata[, caso := factor(caso,
                       levels = c("Obs", "YSU", "MYJ", "ACM2"),
                       ordered = T)]
gdata[ht > 0.02 & date_time %between% c(as_datetime("2016-01-13 12:00:00"), as_datetime("2016-01-15 00:00:00")) ] %>%
  ggplot(aes(date_time, ht)) +
  geom_contour(aes(z = spd_smooth, color = ..level..), binwidth = 1) +
  scale_color_viridis(name = "Magnitud\ndel viento", direction = 1,
                      breaks = seq(0, 18, 3), limits = c(0, 19),
                      guide = guide_colorbar(order = 1)) +
  geom_label_contour2(aes(z = spd_smooth, label = ..level.., color = ..level..),
                    size = 4,
                    breaks = seq(0, 18, 1)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "4 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-13 20:00:00"), NA),
                   expand = c(0,0)) +
  scale_y_continuous(name = "Altura (km)", limits = c(0,2),
                     expand = c(0,0)) +
  facet_wrap(~caso) +
  theme_minimal() + theme(legend.position = "bottom")

```

La variación de la dirección del viento con el tiempo y la altura en cada simulación se muestra en la Figura \ref{modelo-dir}. Nuevamente se observa una similaridad importante entre las tres simulaciones y en líneas generales conservan las características de las observaciones aunque se distinguen algunas diferencias. Para analizar en más detalle el desempeño de las simulaciones se calculó la diferencia de la magnitud del viento entre las observaciones y cada simulación y lo mismo para el ángulo de la dirección del viento (Figura \ref{dif}).


```{r vad-modelo-dir, fig.cap="Dirección del viento (grados) estimada por el radar (Obs) y simulada por el modelo WRF utilizando distintos esquemas de CLP para el Caso 1 (14/01/2016) y posteriormente procesados con VAD. \\label{modelo-dir}", fig.width=0.98*text.width, fig.align='center'}

gdata <- setDT(rbind(vad_20160114, vad_caso1ysu, vad_caso1myj, vad_caso1acm))
gdata[, caso2 := factor(caso,
                       levels = c("Obs", "YSU", "MYJ", "ACM2"),
                       ordered = T)]
gdata[ht > 0.02 & date_time %between% c(as_datetime("2016-01-14 00:00:00"), as_datetime("2016-01-15 00:00:00")) & minute(date_time) == 0 & !is.na(spd_smooth) ] %>%
  ggplot(aes(date_time, ht)) +
  geom_arrow(aes(mag = spd_smooth, angle = di, color = spd_smooth),
             scale = 0.005, start = -90, direction = -1) +
  # geom_point(data = subset(vad_20160114, rmse1 > 0.5),
  #            aes(size = rmse1),
  #            shape = 1, color = "grey25") +
  # geom_point(data = subset(vad_20160114, rmse2 > 0.5),
  #            aes(size = rmse2),
  #            shape = 4, color = "grey25") +
  scale_color_viridis(name = "Velocidad\ndel viento",
                      breaks = seq(0, 18, 3), limits = c(0, 19)) +
  scale_size_continuous(range = c(0, 5), guide = "none") +
  scale_y_continuous(name = "Altura (km)", limits = c(0,2)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "4 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  facet_wrap(~caso2) +
  theme_minimal() + theme(legend.position = "bottom")

```

La diferencia en la magnitud del viento entre las observaciones y la simulación con la parametrización YSU es negativa (sobrestima) en los primeros niveles de altura y positiva (subestima) por encima de 500 m. En los primeros niveles las mayores diferencias se deben a la presencia de un máximo de viento entre las 00 y las 03 UTC en la simulación que no se corresponde con las observaciones y la persistencia del LLJ luego de su decaimiento en las observaciones. La simulación MYJ es la que presenta mayores diferencias con las observaciones tanto en las horas nocturnas como en las horas diurnas, esta diferencia llega valores negativos en niveles superiores durante el día. La parametrización ACM2 se comporta de manera similar a YSU aunque las diferencias en los primeros 500 m parecen ser menores. En líneas generales las tres parametrizaciones tienen un peor desempeño en horas nocturnas sobreestimando el viento en los primeros niveles y subestimandolo en los niveles altos.

En cuanto a la dirección del viento, en la Figura \ref{dif-dir} se muestra el valor absoluto de la diferencia entre el ángulo del vector del viento observado y el simulado. En las tres simulaciones la mayor diferencia se da por encima de 1000 m con valores de hasta 149° en MYJ, 141° en YSU y 131° en ACM2. En los primeros 1000 metros la diferencia es mucho menor y en algunos momentos cercana a cero. Cualitativamente no es posible identificar si alguna de las simulaciones tiene un mejor desempeño al estimar esta variable.


```{r diferencia, fig.cap="Diferencia entre las observaciones y cada simulación para la magnitud del viento (m/s) (a) y el ángulo de la dirección del viento (grados) (b) correspondiente al Caso 1. \\label{dif}", fig.subcap=c("Magnitud del viento (m/s) \\label{dif-spd}", "Ángulo de la dirección del viento (grados) \\label{dif-dir}"), fig.height=0.85*text.height, fig.width=0.48*text.width, fig.ncol=2}

gdata <- setDT(rbind(vad_caso1ysu, vad_caso1myj, vad_caso1acm))

gdata <- gdata[vad_20160114[, .(date_time, ht, spd_obs = spd_smooth, di_obs = di, u_obs = u, v_obs = v)],
      on = c("date_time", "ht")] %>%
  .[, dif_spd := spd_obs - spd_smooth] %>%
  .[, di.c := circular(di, units = "degrees", modulo = "2pi")] %>%
  .[, di_obs.c := circular(di_obs, units = "degrees", modulo = "2pi")] %>%
  .[, dif_di := ifelse(di_obs.c - di.c > 180, di_obs.c - di.c - 360, di_obs.c - di.c)] %>%
  .[, caso2 := factor(caso,
                       levels = c("Obs", "YSU", "MYJ", "ACM2"),
                       ordered = T)]

gdata[ht > 0.02] %>%
  ggplot(aes(date_time, ht)) +
  geom_contour(aes(z = dif_spd, color = ..level..), binwidth = 1) +
  scale_color_divergent(name = "Magnitud\ndel viento",
                      #breaks = seq(0, 18, 2), limits = c(0, 19),
                      guide = guide_colorbar(order = 1)) +
  scale_x_datetime(name = "Tiempo (UTC)",
                   date_breaks = "4 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  scale_y_continuous(name = "Altura (km)", limits = c(0,2),
                     expand = c(0,0)) +
  facet_wrap(~caso2, ncol = 1) +
  theme_minimal() + theme(panel.ontop = T,
                          legend.position="bottom",
                          legend.box = "horizontal")

gdata[ht > 0.02 & caso2 != "Obs" & hour(date_time) < 22] %>%
  ggplot(aes(date_time, ht)) +
  geom_tile(aes(z = abs(dif_di), fill = abs(dif_di)), binwidth = 1) +
  scale_fill_divergent(name = "Dirección\ndel viento",
                      #breaks = seq(0, 18, 2), limits = c(0, 19),
                      guide = guide_colorbar(order = 1)) +
  scale_color_divergent(name = "Dirección\ndel viento") +
  scale_x_datetime(name = "Tiempo (UTC)",
                   date_breaks = "4 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  scale_y_continuous(name = "Altura (km)", limits = c(0,2),
                     expand = c(0,0)) +
  facet_wrap(~caso2, ncol = 1) +
  theme_minimal() + theme(panel.ontop = T,
                          legend.position="bottom",
                          legend.box = "horizontal")
```

En la Tabla \ref{err} se presenta la magnitud del bias, rmse, rmsens y del coeficiente de correlación de la magnitud y la dirección del viento calculados de manera global para las tres simulaciones, es decir para todo momento y nivel. El rmse que cuantifica el error total y el rmsens asociado a los errores no sistemáticos de la velocidad son muy similares y por lo tanto puede determinarse que las diferencias entre las observaciones y cada simulación se debe principalmente a los errores no sistemáticos. En concordancia con el análisis cualitativo, MYJ tiene un mayor rmse mientras que en YSU y ACM2, son similares. Sin embargo ACM2 es la simulación con mayor bias y MYJ tiene el menor. En los tres casos el bias es negativo y por lo tanto globalmente la magnitud del viento está subestimada en las simulaciones. La mayor correlación se da entre las observaciones y ACM2 y es menor con YSU y MYJ.

El error total, el error no sistemático y el bias calculado para la dirección del viento son similares en las tres simulaciones. En este caso MYJ muestra errores menores que YSU y ACM2 a diferencia de lo sucedido con la magnitud del viento. El rmsens es menor al rmse (representa entre el 80 y 83% del rmse), por lo que los errores sistemáticos representados por el bias también son importantes en esta variable.


```{r err-spd, fig.cap="Bias, rmse y rmsens en m/s y coeficiente de correlación para la estimación de la velocidad del viento (m/s) con cada simulación en función de la altura y la simulación. \\label{err-spd}", fig.width=0.75*text.width, fig.align='center'}

gdata <- setDT(rbind(vad_caso1ysu, vad_caso1myj, vad_caso1acm)) %>%
  .[vad_20160114[ht != 0.01, .(ht, date_time, obs = spd_smooth)], on = c("ht", "date_time")] %>%
  .[day(date_time) == 14 & ht <= 2.0] %>%
  .[, .(bias = bias.f(spd_smooth, obs),
        rmse = rmse.f(spd_smooth, obs),
        rmsens = rmsens.f(spd_smooth, obs),
        correlación = cor(spd_smooth, obs, use = "complete.obs")), by = .(caso, ht)] %>%
  .[, caso := factor(caso,
                       levels = c("YSU", "MYJ", "ACM2"),
                       ordered = T)] %>%
  melt(id.vars = c("caso", "ht"))

hline <- data.frame(y = 0, variable = c("bias", "correlación"))
ggplot(gdata, aes(ht, value)) +
  geom_hline(data = hline, aes(yintercept = y), color = "darkgray") +
  geom_line(aes(color = caso)) +
  scale_color_viridis(name = "Simulación", discrete = T, option = "viridis") +
  scale_x_continuous(name = "Altura (km)") +
  scale_y_continuous(name = NULL) +
  coord_flip() +
  facet_wrap(~variable, scales = "free") +
  theme_minimal() + theme(legend.position = "bottom")

```

```{r err-tabla}

gdata <- setDT(rbind(vad_caso1ysu, vad_caso1myj, vad_caso1acm)) %>%
  .[vad_20160114[ht != 0.01, .(ht, date_time, obs = spd_smooth)],
    on = c("ht", "date_time")] %>%
  .[day(date_time) == 14 & ht <= 2.0] %>%
  .[, .(bias = bias.f(spd_smooth, obs),
        rmse = rmse.f(spd_smooth, obs),
        rmsens = rmsens.f(spd_smooth, obs),
        correlación = cor(spd_smooth, obs, use = "complete.obs")), by = .(caso)]
err <- gdata

gdata <- setDT(rbind(vad_caso1ysu, vad_caso1myj, vad_caso1acm)) %>%
  .[vad_20160114[ht != 0.01, .(ht, date_time, obs = di)],
    on = c("ht", "date_time")] %>%
  .[day(date_time) == 14 & ht <= 2.0] %>%
  .[, .(di, obs,
        di.c = circular(di, units = "degrees", modulo = "2pi"),
        obs.c = circular(obs, units = "degrees", modulo = "2pi")),
    by = .(caso)] %>%
  .[, .(di, obs, di.c, obs.c,
        dif.di = ifelse(obs.c - di.c > 180, obs.c - di.c - 360, obs.c - di.c)),
    by = .(caso)] %>%
  .[, .(bias = bias.c(dif.di),
        rmse = rmse.c(dif.di),
        rmsens = rmsens.c(dif.di),
        correlación = cor.circular(di.c, obs.c)), by = .(caso)]

err <- cbind(err, gdata)
err[,6] <- NULL

kable(err, format = "latex",
      digits = 3,
      booktabs = T,
      caption = "Comparación entre las simulaciones y las observaciones de radar a partir de distintos errores. El bias, rmse, rmsens se expresan en m/s. \\label{err}") %>%
  add_header_above(c(" ", "Velocidad" = 4, "Dirección" = 4)) #%>%
  #kable_styling(latex_options = "hold_position")
```

Otro aspecto importante para analizar es el comportamiento de los errores con la altura. Para eso se calcularon el bias, rmse, rmsens y el coeficiente de correlación de la magnitud del viento para cada nivel y simulación (Figura \ref{err-spd}). En todas las simulaciones el bias tiene un comportamiento similar con la altura, siendo positivo por debajo de 600 m y negativo por encima. Esto significa que si bien globalmente el bias es negativo y por lo tanto las simulaciones subestiman la magnitud del viento, las tres parametrizaciones sobreestiman la variable en los primeros niveles de la atmósfera. La mayor diferencia de bias entre las simulaciones se da en los niveles inferiores entre 200 y 300 m donde MYJ tiene un bias 1 m/s mayor que ACM2. El perfil vertical del rmse tiene un mínimo en 500 m para todas las simulaciones y aumenta tanto en el nivel del LLJ como por encima de los 500 m. La simulación MYJ tiene un mayor rmse en casi todos los niveles respecto de YSU y ACM2. Los errores no sistemáticos son más importantes alrededor de 1000 m y por encima de 500 m MYJ tiene un rmsens mayor a las otras simulaciones que suma a su error total. En cuanto al coeficiente de correlación, en los primeros niveles y hasta los 600 m aproximadamente es superior a 0.9 y con un comportamiento muy similar en las tres simulaciones. Luego de ese nivel donde las simulaciones no pueden representar las condiciones del viento, y la correlación rápidamente hasta llegar a valores cercanos a cero o negativos por encima de 1000 m. Como en el caso de los errores MYJ tiene el peor desempeño de las tres simulaciones.

### Características de la capa límite planetaria

Los perfiles mostrados en la Figura \ref{perfil-mod} correspondientes a las 17 UTC muestran las características de la capa mezclada. El perfil observado muestra un ligero aumento con la altura pero mantiene la homogeneidad característica de la capa mezclada. Las tres simulaciones presentan un perfil con un comportamiento similar, son verticalmente homogéneos con una ligera disminución de la magnitud del viento con la altura al contrario de lo que ocurre en horas nocturnas. La comparación de los perfiles con las observaciones muestra que son similares a pesar de que el viento en los primeros niveles es sobreestimado por las simulaciones en hasta 2 m/s.

#### Oscilación inercial y LLJ

Si bien el máximo del viento en la capa estable se da en distintos momentos en cada simulación y con respecto a las observaciones, se comparó el perfil vertical de viento a las 06 UTC como hora de referencia donde se observa el LLJ (Figura \ref{perfil-mod}). Los perfiles de las tres simulaciones tienen un comportamiento similar mostrando la característica "nariz" de LLJ, y tienen diferencias de hasta 2 m/s en algunos niveles. Como se observó en la Figura \ref{modelo-spd} durante la noche, la magnitud del viento disminuye rápidamente luego del máximo, llegando a un mínimo de entre 2 y 3 m/s en las simulaciones respecto de los 8 m/s observados por el radar a 1000 m, lo que genera el bias negativo mostrado previamente.

Al aplicar el criterio de Bonner en todas las simulaciones se puede determinar cuantitativamente la presencia del LLJ, que a las 06 UTC tiene el máximo ubicado en 200 m y con magnitudes que varían entre 14 y 16 m/s, mientras que el máximo en las observaciones está 100 m por encima. Sin embargo, la Figura \ref{modelo-spd} muestra que en las simulaciones el LLJ se prolonga en el tiempo más que en las observaciones ya que el máximo viento ocurre dos horas después (posterior a las 8 UTC) y con magnitud entre 1 y 2 m/s superior a lo observado.


```{r perfiles-mod, fig.cap="Perfil de viento (m/s) observado por el radar a las 06 y las 17 UTC y perfiles simulados por el modelo para los mismos momentos. Las marcas en los ejes indican la magnitud del viento máxima y mínima y la altura a la que ocurren. \\label{perfil-mod}", fig.width=0.95*text.width, fig.align='center'}

gdata <- setDT(rbind(vad_20160114, vad_caso1ysu, vad_caso1myj, vad_caso1acm))
gdata[, caso := factor(caso,
                       levels = c("Obs", "YSU", "MYJ", "ACM2"),
                       ordered = T)] %>%
  .[, hora := hour(date_time)] %>%
  .[minute(date_time) == 00 & day(date_time) == 14 & hour(date_time) %in% c(06, 17) & ht < 2.5 &
      !is.na(spd_smooth)] %>%
  ggplot(aes(ht, spd_smooth, color = caso)) +
  geom_line() +
  geom_rug(data = gdata[minute(date_time) == 00 & hour(date_time) == 6][, maxspd := max(spd_smooth, na.rm = T), by = caso][spd_smooth == maxspd]) +
  geom_rug(data = gdata[minute(date_time) == 00 & hour(date_time) == 6 & ht > 0.5][, minspd := min(spd_smooth, na.rm = T), by = caso][spd_smooth == minspd]) +
  # geom_ribbon(aes(ymin = spd_smooth - rmse2, ymax = spd_smooth + rmse2,
  #             fill = as.factor(hour(date_time))),
  #             alpha = 0.5, color = NA) +
  coord_flip() +
  scale_color_manual(name= NULL, values = c("#B63679FF", viridis_pal()(3))) +
  scale_y_continuous(name = "V (m/s)") +
  scale_x_continuous(name = "Altura (km)", breaks = seq(0, 2.5, 0.5),
                     limits = c(0, 2.5)) +
  facet_wrap(~hora, labeller = labeller(hora = c("6" = "06 UTC", "17" = "17 UTC"))) +
  theme_minimal()
```

En la Figura \ref{hodografa-mod} se presentan las hodógrafas temporales observadas para distintos niveles en el Caso 1 y las obtenidas a partir de las tres simulaciones. Al igual que en figuras anteriores, las simulaciones tienen un comportamiento similar entre sí. En el primer nivel de 0.3 km las hodógrafas tiene la forma de herradura pronosticada por el modelo de Van de Wiel aunque la magnitud del viento en las simulaciones es superior a lo observado en las primeras 10 horas mostradas. El nivel de 0.5 km también presenta la característica forma de herradura pero en este caso la magnitud del viento de las distintas simulaciones es similar a la observada en las primeras horas y luego es menor.

Sin embargo, en el nivel de 1 km, si bien la hodógrafa observada presenta la forma de herradura y se ajusta cualitativamente al modelo de oscilación inercial, no ocurre lo mismo en las simulaciones. En primer lugar, al igual que se observó en la Figura \ref{modelo-spd}, la magnitud del viento es mucho menor a las observaciones ya que decrece rápidamente con la altura (Figura \ref{perfil-mod}) pero además la rotación alrededor de un perfil de equilibrio no se observa en ninguna de las simulaciones y por lo tanto no se ajustan al modelo de oscilación inercial. A partir de esto puede verse que las simulaciones si bien puede representar la oscilación inercial, ésta está asociada a mayores intensidades de viento pero a su vez su extensión vertical es menor. Esto podría estar asociado a una subestimación del tope de la capa mezclada del día anterior, o podría deberse a una cortante intensa en el perfil de viento inicial correspondiente al atardecer del día previo [@Blackadar1957].


```{r hodografa-wrf, fig.cap="Hodógrafa temporal para tres niveles. Cada círculo representa un valor horario (con circulos más grandes cada 4 horas) y el cuadrado marca el primer tiempo (00 UTC). \\label{hodografa-mod}", fig.width=0.95*text.width, fig.align='center'}

gdata <- rbind(vad_20160114, vad_caso1ysu, vad_caso1myj, vad_caso1acm)
gdata <- as.data.table(gdata) %>%
  .[, hora := hour(date_time)] %>%
  .[minute(date_time) == 00 & day(date_time) == 14 & hora < 13] %>%
  .[, caso2 := factor(caso,
                       levels = c("Obs", "YSU", "MYJ", "ACM2"),
                       ordered = T)]

gdata[ht %in% c(0.3, 0.5, 1.0) & !is.na(spd_smooth)] %>%
  ggplot(aes(u, v,  color = caso2)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "darkgrey") +
  geom_point(aes(x = ifelse(hour(date_time) != 0, u, NA)), size = 1) +
  geom_point(aes(x = ifelse(hour(date_time) %in% c(0,4,8,12), u, NA)),
             size = 2) +
  geom_point(aes(x = ifelse(hour(date_time) == 0, u, NA)), shape = 15,
             size = 3) +
  geom_path() +
  # geom_text_repel(aes(label = JumpBy(hora, 6, fill = NA)),
  #                  data = gdata[ht %in% c(0.3, 0.5, 1.0)]) +
  scale_color_manual(name="Altura", values = c("#B63679FF", viridis_pal()(3))) +
  scale_x_continuous(name = "u (m/s)") +
  scale_y_continuous(name = "v (m/s)") +
  coord_equal() +
  facet_wrap(~ht) +
  theme_minimal()

```



```{r leo-pbl}

caso.YSU <- ReadNetCDF(paste(path,"caso1_YSU/spd_YSU.nc", sep = "")) %>%
  mutate(exchh = ReadNetCDF(paste(path,"caso1_YSU/exchh_YSU.nc", sep = ""), out = "vector")[[1]],
         pblh = ReadNetCDF(paste(path,"caso1_YSU/pblh_YSU.nc", sep = ""), out = "vector")[[1]],
         ust = ReadNetCDF(paste(path,"caso1_YSU/ust_YSU.nc", sep = ""), out = "vector")[[1]],
         L = ReadNetCDF(paste(path,"caso1_YSU/l_YSU.nc", sep = ""), out = "vector")[[1]],
         param = "YSU") %>%
  .[, lev := lev*1000 - 73] %>%
  .[, c("pblh", "ust", "L") := .(pblh[1], ust[1], L[1]), by = .(date, lon, lat, param)] %>%
  .[, regimen := ifelse(L <= 0, "Inestable", "Estable")] %>%
  .[date %between% as.POSIXct(c("2016-01-13 22:10:00", "2016-01-14 22:00:00"), tz = "UTC"), ] %>%
  .[inside(lon, lat) == T] %>%
  .[lev > -25,]

caso.MYJ <- ReadNetCDF(paste(path,"caso1_MYJ/spd_MYJ.nc", sep = "")) %>%
  mutate(exchh = ReadNetCDF(paste(path,"caso1_MYJ/exchh_MYJ.nc", sep = ""), out = "vector")[[1]],
         pblh = ReadNetCDF(paste(path,"caso1_MYJ/pblh_MYJ.nc", sep = ""), out = "vector")[[1]],
         ust = ReadNetCDF(paste(path,"caso1_MYJ/ust_MYJ.nc", sep = ""), out = "vector")[[1]],
         L = ReadNetCDF(paste(path,"caso1_MYJ/l_MYJ.nc", sep = ""), out = "vector")[[1]],
         param = "MYJ") %>%
  .[, lev := lev*1000 - 73] %>%
  .[, c("pblh", "ust", "L") := .(pblh[1], ust[1], L[1]), by = .(date, lon, lat, param)] %>%
  .[, regimen := ifelse(L <= 0, "Inestable", "Estable")] %>%
  .[date %between% as.POSIXct(c("2016-01-13 22:10:00", "2016-01-14 22:00:00"), tz = "UTC"), ] %>%
  .[inside(lon, lat) == T] %>%
  .[lev > -25,]

caso.ACM2 <- ReadNetCDF(paste(path,"caso1_ACM2/spd_ACM2.nc", sep = "")) %>%
  mutate(exchh = ReadNetCDF(paste(path,"caso1_ACM2/exchh_ACM2.nc", sep = ""), out = "vector")[[1]],
         pblh = ReadNetCDF(paste(path,"caso1_ACM2/pblh_ACM2.nc", sep = ""), out = "vector")[[1]],
         ust = ReadNetCDF(paste(path,"caso1_ACM2/ust_ACM2.nc", sep = ""), out = "vector")[[1]],
         L = ReadNetCDF(paste(path,"caso1_YSU/l_YSU.nc", sep = ""), out = "vector")[[1]],
         param = "ACM2") %>%
  .[, lev := lev*1000 - 73] %>%
  .[, c("pblh", "ust", "L") := .(pblh[1], ust[1], L[1]), by = .(date, lon, lat, param)] %>%
  .[, regimen := ifelse(L <= 0, "Inestable", "Estable")] %>%
  .[date %between% as.POSIXct(c("2016-01-13 22:10:00", "2016-01-14 22:00:00"), tz = "UTC"), ] %>%
  .[inside(lon, lat) == T] %>%
  .[lev > -25,]

all.pbl <- rbind(caso.YSU, caso.MYJ, caso.ACM2) %>%
  .[lat %~% -31.8484 & lon %~% -60.5372] %>%
  .[, param :=  factor(param,
                       levels = c("YSU", "MYJ", "ACM2"),
                       ordered = T)]

#saveRDS(all.pbl[lev == 25, .(pblh, date, param)], "pblh")

remove(list = c("caso.YSU", "caso.MYJ", "caso.ACM2"))
```

Un parámetro importante que permite caracterizar la capa límite es la Longitud de Monin-Ovukhov ($L$). Esta magnitud depende de la velocidad de fricción, de la temperatura y del flujo vertical de calor sensible. La variable permite reconocer el período estable de la capa límite, es decir, la capa estable nocturna y el período instable correspondiente a la capa mezclada. Debido a que el signo depende de $(\overline{w'\theta '})_s$ y este a su vez que cambia su signo en la transición entre una capa y la otra, $L$ tiende a infinito a estos momentos. En la Figura \ref{L-param} se presenta la variación de $L$ a lo largo del tiempo en cada simulación. El comportamiento de $L$ es acorde a lo descripto por @Stull1988 para condiciones de buen tiempo y clasifica los períodos estable e inestable de manera correcta.


```{r L-parm, fig.cap="Longitud de Monin Obukhov (m) en función del tiempo, para cada simulación. Los puntos violetas corresponden al régimen estable (nocturno) y los puntos rosas corresponden al régimen inestable (diurno) \\label{L-param}", fig.width=0.95*text.width, fig.align='center'}

ggplot(all.pbl, aes(date, L)) +
  geom_point(aes(color = regimen)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  scale_color_manual(name = "Regimen", values = color_manual) +
  scale_y_continuous(name = "L (m)", breaks = seq(-400, 300, 50)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "6 hours",
                   date_labels = "%H") +
  facet_wrap(~param) +
  theme_minimal()

```


#### Altura de la capa límite

En esta sección se analiza la altura de la capa límite a partir de la estimación realizada por cada simulación y se comparan con los resultados obtenidos de las observaciones de radar. En la Figura \ref{pblh} se muestra la altura de la capa límite estimada por cada parametrización en todo el período en el punto más cercano al radar de Paraná. Es importante tener en cuenta que cada parametrización estima esta variable de manera distinta. En líneas generales la evolución del tope de la capa límite es consistente con el comportamiento esperado para el tope de la CLP en días despejados. Por ejemplo las tres parametrizaciones convergen en las últimas horas de la capa estable nocturna y marcan el comienzo del crecimiento de la capa mezclada pasadas las 10 UTC, esto es aproximadamente una hora posterior al amanecer pero divergen de manera considerable al estimar el tope de la capa mezclada.

En YSU la altura de la capa estable es mayor a las otras dos parametrizaciones mientras que durante el día la estimación queda por debajo o entre las otras. MYJ presenta las mayores variaciones del tope de la capa mezclada, inicialmente su crecimiento es muy rápido superando los 1000 metros en una hora pero posteriormente el crecimiento se desacelera con un período de decrecimiento luego de las 17 UTC. Si bien en presencia de nubosidad el tope de la capa mezclada puede verse afecta de esta manera, el resto de las condiciones meteorológicas no se vieron afectadas y por lo tanto no sería la razón de la disminución del tope de la CLP. Tampoco se observa el decrecimiento del tope en las otras simulaciones por lo que es posible que no esté reflejando el comportamiento real de la capa mezclada. La parametrización ACM2 genera la capa mezclada más profunda superando los 2500 m o 1872 m en promedio para todo el período inestable (Tabla \ref{tabla-clp}). En resumen, ACM2 produce la capa mezclada más profunda, seguidas por YSU y MYJ. Este resultado fue obtenido por otros autores [por ejemplo @Hu2010; @Xie2012] y puede deberse a las características de las distintas parametrizaciones. En particular MYJ es un esquema local y por lo tanto el transporte vertical de las distintas propiedades es más débil. Sumando a lo anterior, MYJ produce un menor intercambio de temperatura y humedad con la atmósfera libre limitando el crecimiento de la capa límite [@Xu2010].

Para obtener una estiación de la altura de la CLP bajo un único método, se utilizó el criterio descripto en la Sección \ref{sec-pbh} para estimar la altura de la capa estable en las tres simulaciones. En la Figura \ref{pblh-spd} se muestra la altura de la capa estable nocturna estimada por cada parametrización en líneas y la estimada utilizando la altura a la que ocurre el máximo viento en puntos. Si bien este criterio está limitado por la resolución de la retícula vertical utilizada por el VAD, se observa una concordancia entre las estimaciones con MYJ y ACM2 principalmente en los momentos donde se produce el máximo LLJ.

```{r pblh-wrf, fig.cap="Altura de la capa límite (m) en cada simulación. \\label{pblh-wrf}", fig.subcap=c("Estimada directamente por cada esquema de CLP. \\label{pblh}", "Comparación entre la altura calculada por cada esquema (línea) y la estimada a partir de la altura del viento máximo (puntos) sólo en el período estable. \\label{pblh-spd}"), fig.width=0.75*text.width, fig.height=0.35*text.height, fig.align='center', fig.ncol=1}

all.pbl[lev < 30] %>%
  ggplot(aes(date, pblh)) +
  geom_vline(xintercept = as_datetime("2016-01-14 09:40:00"),
             color = "darkgray") +
  geom_line(aes(color = param), linetype = 1) +
  scale_color_viridis(name = "Simulación", discrete = T, option = "viridis") +
  scale_y_continuous(name = "Altura de la capa límite (m)", limits = c(0, 3000)) +
  scale_x_datetime(name = "Hora UTC",
                   date_breaks = "4 hours",
                   date_labels = "%H") +
  theme_minimal()

all.pbl[lev < 2500 & L >=0 , .(pblh = pblh[1], pblh.spd = lev[which.max(spd)], L = L[1]), by = .(date, param)] %>%   
  # .[!is.na(pblh), ] %>%
  ggplot(aes(date, pblh)) +
  # geom_vline(xintercept = as_datetime("2016-01-14 09:40:00"),
  #            color = "darkgray") +
  geom_line(aes(color = param), linetype = 1) +
  geom_point(aes(y = pblh.spd, color = param)) +
  scale_color_viridis(name = "Simulación", discrete = T, option = "viridis") +
  scale_y_continuous(name = "Altura de la capa límite (m)") +
  scale_x_datetime(name = "Hora UTC",
                   date_breaks = "3 hours",
                   date_labels = "%H",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
   coord_cartesian(ylim = c(0, 600)) +
  facet_wrap(~param, ncol = 1) +
  theme_minimal()

```

La Figura \ref{dbz-wrf} permite comparar la estimación de la altura de la capa límite a partir de la variación del gradiente vertical de reflectividad con la altura (en colores) y las estimaciones de cada simulación (en símbolos). En las primeras horas de la noche el tope de la capa estable se encuentra por debajo de los 200 m de acuerdo a las parametrizaciones y no es posible compararlo con $\nabla_{z}dBZ$ debido al ruido de esta variable en los primeros metros (no se muestra). Posteriormente el $\nabla_{z}dBZ$ presenta un máximo a 300 m de altura desde las 04 UTC mientras que la altura de la capa límite estimada por las observaciones llega a esa altura pasadas las 05 UTC. La altura de la capa estable se mantienen alrededor de ese nivel hasta las 10 UTC mientras que $\nabla_{z}dBZ$ crece rápidamente a partir de las 09 UTC. De acuerdo a esto la capa límite estimada por las parametrizaciones parece *retrasada* respecto de las observaciones en aproximadamente dos horas.

El desarrollo de la capa mezclada en las parametrizaciones parece ser más lento en comparación con las observaciones de $\nabla_{z}dBZ$, puesto que el tope crece más lentamente y lo hace casi dos horas después. ACM2 sobreestima la altura de la capa mezclada y sucede algo similar con YSU aunque la señal del máximo $\nabla_{z}dBZ$ desaparece en el momento donde ocurre la máxima altura para YSU. El comportamiento de MYJ si bien es muy diferente al observado en las otras dos simulaciones, tiene características semejantes a la altura de la CLP estimada con las observaciones. En primer lugar, al comenzar el desarrollo de la capa mezclada, el tope de la capa estimada por MYJ crece rápidamente y al mismo ritmo que en las observaciones aunque una hora después. La desaceleración observada posteriormente coincide con uno de los máximos de $\nabla_{z}dBZ$ observados entre las 10 y las 15 UTC para luego profundizarse hasta alcanzar los 2000 m de altura al igual que las observaciones. El descenso observado en esta simulación también está presente en la variación de la reflectividad pero no así el posterior crecimiento. Sin embargo es posible que el máximo inferior entre las 10 y las 15 UTC esté asociado a variaciones en la reflectividad que no tienen relación con la altura de la CLP.

```{r dbz-wrf, fig.cap="Valor absoluto del gradiente vertical de reflectividad (dBZ/m) en función de la altura y el tiempo para el Caso 1 y la altura de la capa límite estimada en cada simulación. \\label{dbz-wrf}", fig.align='center',  fig.height=0.4*text.height}
elev <- unique(dbz_20160114$elevacion)
pbl <- readRDS("pblh")
dbz_20160114[elevacion == elev[8] & ht_reg > 200] %>%
  ggplot(aes(date, ht_reg/1000)) +
  geom_tile(aes(fill = abs(ddbz), color = abs(ddbz))) +
  scale_fill_viridis(name = "Gradiente \n vertical de \n reflectividad",
                     limits = c(0, 0.06)) +
  scale_color_viridis(name = "Gradiente \n vertical de \n reflectividad",
                      limits = c(0, 0.06)) +
  scale_y_continuous(name = "Altura (km)", limits = c(0, 3)) +
  scale_x_datetime(name = "Hora (UTC)",
                   date_breaks = "3 hour",
                   date_labels = "%H:%M",
                   limits = c(as_datetime("2016-01-14 00:00:00"), NA),
                   expand = c(0,0)) +
  geom_point(data = pbl, aes(date, pblh/1000, shape = param), size = 1) +
  scale_shape_discrete(name = "Simulación") +
  theme_minimal()
remove(files, dbz_20160114)
```


#### Coeficientes de difusividad turbulenta

```{r make-ulke}
all.pbl <- all.pbl[, c("kh.u", "km.u", "u.u") := .(
  kh.ulke(lev, pblh, L, ust),
  km.ulke(lev, pblh, L, ust),
  u.ulke(lev, pblh, L, ust))] %>%
  .[, Pr := km.u/kh.u]
```

El análisis de los coeficientes de difusividad turbulenta determinan el transporte vertical turbulento de distintas propiedades y permite conocer la estructura de la CLP. Debido a que solo el coeficiente de difusividad de calor sensible ($K_h(z)$) pudo obtenerse como variable de salida en las simulaciones del modelo, se estimó el coeficiente de cantidad de movimiento ($K_m(z)$) a partir de su relación con el número de Prandtl ($Pr = K_m/K_h$) y el $K_h$ de cada simulación.

Por otro lado el número de Prandtl se estimó calculando los perfiles verticales de los coeficientes de difusividad propuestos por el modelo de @Ulke2000 para cada período estable e inestable. Cada perfil fue obtenido utilizando los valores de $L$, $u_*$ y $h$ estimados en cada simulación por el modelo. Los valores promedio de estos parámetros para cada régimen y simulación se presentan en la Tabla \ref{tabla-clp}.  

Los perfiles calculados (no se muestran), presentan una estructura acorde al modelo teórico propuesto para las tres parametrizaciones. Las diferencias encontradas entre los perfiles calculados para cada simulación están asociadas a los parámetros utilizados en cada caso. En la Figura \ref{Pr} se muestran los perfiles verticales del número de Prandtl estimados a partir de los perfiles del modelo @Ulke2000. Se observa un comportamiento similar en todas la simulaciones, en particular no hay diferencias entre YSU y ACM2 mientras que el perfil de MYJ se separa de los otros dos. En todos los casos varía en los primeros 200 m y luego es aproximadamente constante con la altura, lo que es esperable para este parámetro.


```{r pr, fig.cap="Variación del número de Prandtl calculado a partir del modelo propuesto por Ulke 2000 con las variables de cada simulación y promediado en cada periodo. \\label{Pr}", fig.align='center', fig.width=0.95*text.width}
all.pbl_norm <- all.pbl[, `:=`(kh.u_norm = kh.u/(ust*0.4*pblh),
             km.u_norm = km.u/(ust*0.4*pblh),
             lev_norm = lev/pblh),
             by = .(param, regimen)] %>%
  .[, .(lev_norm = seq(0, 1, by = 0.1),
        kh.u_norm = approx(lev_norm, kh.u_norm, xout = seq(0, 1, by = 0.1))$y,
        km.u_norm = approx(lev_norm, km.u_norm, xout = seq(0, 1, by = 0.1))$y),
    by = .(param, regimen, date)] %>%
  .[, lapply(.SD, mean, na.rm = T), by = .(param, lev_norm, regimen), .SDcols = -"date"]

group_by(all.pbl, param, lev, regimen) %>%
  summarise(Pr = mean(Pr, na.rm = T)) %>%
ungroup() %>%
ggplot(aes(lev, Pr)) +
  geom_line(aes(color = as.factor(param))) +
  scale_color_viridis(name = "Esquema",discrete = T, option = "viridis",
                       labels=c(expression(U2000[YSU]),
                               expression(U2000[MYJ]),
                               expression(U2000[ACM2]))) +
  scale_y_continuous(name = "Km/Kh", expand = c(0,0)) +
  scale_x_continuous(name = "z(m)", limits = c(0,1500)) +
  facet_wrap(~regimen, scales = "free") +
  coord_flip() +
  theme_minimal()
```

```{r tabla-clp}
hL <- group_by(all.pbl, param, regimen) %>%
  summarise(h_mean = mean(pblh, na.rm = T),
            L_mean = mean(L, na.rm = T),
            ust_mean = mean(ust, na.rm = T),
            Pr_mean =  mean(Pr, na.rm = T)) %>%
  .[, hL := h_mean/L_mean]

names(hL) <-  c("Simulación", "Regimen", "$\\overline{h}$", "$\\overline{L}$", "$\\overline{u*}$", "$\\overline{Pr}$", "$h/L$")

names(hL)[3] <- paste0(names(hL)[3], footnote_marker_number(1, "latex"))
names(hL)[4] <- paste0(names(hL)[4], footnote_marker_number(2, "latex"))
names(hL)[5] <- paste0(names(hL)[5], footnote_marker_number(3, "latex"))
names(hL)[6] <- paste0(names(hL)[6], footnote_marker_number(4, "latex"))

kable(hL, "latex",
      caption = "Parámetros característicos de la capa límite para cada simulación y regimen, promediados para todo el periodo y todo el perfil (en los casos que corresponda). \\label{tabla-clp}",
      escape = F,
      booktabs = T,
      digits = c(0,0,2,2,4,2,2)) %>%
  kable_styling(full_width = F) %>%
  footnote(general_title = "Nota",
           escape = F,
           number = c("Altura de la CLP promediada.",
                      "Longitud de Monin Obukhov promediada.",
                      "Velocidad de fricción promediada.",
                      "Número de Prandtl promediado.")) # %>%
  #kable_styling(latex_options = "hold_position")
```



Finalmente se obtuvieron los perfiles de $K_m$ utilizando los valores del número de Prandtl y el $K_h$ disponible en el resultado de cada simulación. En la Figura \ref{k-ulke-wrf} se muestran los perfiles verticales de $K_m$ y de $K_h$ para cada simulación obtenidos a partir del promedio de la variable en cada nivel durante un período estable (05 a 06 UTC) y un período inestable (16 a 17 UTC). Los perfiles de $K_h$ y $K_m$ obtenidos para el régimen estable presentan mucha variación temporal durante el período por lo que solo se muestra el promedio obtenido durante las horas más representativas.

En el período estable es esperable que el coeficiente de difusividad tenga un máximo dentro de la capa límite estable nocturna y que tienda rápidamente a valores cercanos a cero por encima del tope de la capa [@Klein2016]. Sin embargo se observa que en las tres simulaciones el máximo de difusividad se encuentra entre 750 y 1000 m de altura, mientras que es casi nulo en niveles superiores e inferiores. Este comportamiento podría estar explicado por la presencia de turbulencia en esos niveles debido a la importante cortante por encima del LLJ. Esta cortate es superior a la observada con el radar (Figura \ref{perfil-mod}) y podría estar asociada al transporte turbulento de cantidad de movimiento desde el nivel del LLJ hacia niveles superiores. Sin embargo, con los datos disponibles no es posible determinar si efectivamente hay turbulencia en esos niveles.
De acuerdo a los perfiles obtenidos, YSU genera una mezcla más profunda que las otras parametrizaciones ya que el máximo ocurre en mayor altura y los coeficientes de difusividad tienen mayor magnitud. En el otro extremo MYJ muestra una mezcla menor con un máximo en niveles inferiores a YSU, esto es esperable debido a que MYJ es un esquema local y por lo tanto el transporte vertical será más débil. De acuerdo con @Klein2016 una mayor mezcla vertical está asociada a un LLJ menos intenso debido a que la mezcla podría generar divergencia de cantidad de movimiento en la capa del LLJ debilitándolo. En concordancia a lo anterior, en la Figura \ref{perfil-mod} se observa que el perfil de viento simulado por MYJ está asociado a un LLJ más intenso que en las otras simulaciones. El máximo intenso en los perfiles de los coeficientes turbulentos para YSU podría explicar la presencia de un LLJ más débil debido al mayor transporte de cantidad de movimiento por encima del jet que además genera una cortante más suave en concordancia a lo encontrado por @Klein2016.

Los perfiles del período inestable divergen entre las distintas simulaciones en los primeros 2000 m pero luego de ese nivel convergen a cero debido que ese nivel se encuentra fuera de la CLP. En este régimen MYJ muestra las mayores magnitudes de los coeficientes de difusividad y por lo tanto genera una mezcla más intenta. El máximo en los perfiles de los coeficientes ocurren en niveles menores a las otras parametrizaciones, esto está asociado a una capa mezclada menos profunda (Figura \ref{pblh}), y también explica que el perfil de de los coeficientes se anule en 1500 m de altura aproximadamente.
YSU y ACM2 presentan capas muy profundas en comparación con MYJ ya que llegan cero a los 2000 m, pero la mezcla durante el día es menos intensa al contrario que lo que ocurre durante la noche. Si bien sería importante analizar los perfiles de los coeficientes de difusividad turbulenta de la capa mezclada del día previo al Caso 1 para analizar cómo eso afecta al desarrollo del LLJ observado, es posible que una menor mezcla durante el día, es decir un $K$ más débil, y lo contrario durante la noche explique la menor intensidad del LLJ en YSU y ACM2.

```{r k_ulke_wrf, fig.cap="Coeficientes de difusividad turbulenta de calor sensible (a) y cantidad de movimiento (b) promediados entre las 05 y 06 UTC (período estable, izquierda) y entre las 16 y 17 UTC (período inestable, derecha) de la capa límite en todas las simulaciones.  \\label{k-ulke-wrf}", fig.subcap=c("Calor $K_h$ ($m^2/s$). \\label{kh-wrf}", "Moviento $K_m$ ($m^2/s$). \\label{km-wrf}"), fig.align='center', fig.width=0.98*text.width, fig.ncol=1, fig.height=0.40*text.height}

all.pbl <- all.pbl[, exchm := Pr*exchh]

# ggplot(all.pbl[regimen == "Estable"], aes(lev, exchh, group = factor(lev))) +
#   geom_boxplot() +
#   facet_wrap(~param)

d <- all.pbl[date %between% c(as_datetime("2016-01-14 04:00:00"), as_datetime("2016-01-14 05:00:00")) | date %between% c(as_datetime("2016-01-14 16:00:00"), as_datetime("2016-01-14 17:00:00"))] %>%
  group_by(param, lev, regimen) %>%
  summarise(Kh.m = median(exchh, na.rm = T), Km.m = median(exchm, na.rm = T)) %>%
  ungroup()

# ggplot(all.pbl[date %between% c(as_datetime("2016-01-14 04:00:00"), as_datetime("2016-01-14 07:00:00"))], aes(lev, exchh)) +
#   geom_line(aes(color = as.factor(param))) +
#   scale_color_viridis(name = "Esquema",discrete = T, option = "viridis") +
#   scale_y_continuous(name = expression(paste(K[h], " (", m^2,s^{-1}, ")"))) +
#   scale_x_continuous(name = "Altura sobre el nivel del suelo (Km)",
#                      limits = c(0, 500)) +
#   facet_wrap(~date, scales = "free") +
#   coord_flip() +
#   theme_minimal()

ggplot(d, aes(lev, Kh.m)) +
  geom_line(aes(color = as.factor(param))) +
  scale_color_viridis(name = "Esquema",discrete = T, option = "viridis") +
  scale_y_continuous(name = expression(paste(K[h], " (", m^2,s^{-1}, ")"))) +
  scale_x_continuous(name = "Altura sobre el nivel del suelo (km)",
                     limits = c(0, 2500)) +
  facet_wrap(~regimen, scales = "free") +
  coord_flip() +
  theme_minimal()

ggplot(d, aes(lev, Km.m)) +
  geom_line(aes(color = as.factor(param))) +
  scale_color_viridis(name = "Esquema",discrete = T, option = "viridis") +
  scale_y_continuous(name = expression(paste(K[m], " (", m^2,s^{-1}, ")"))) +
  scale_x_continuous(name = "Altura sobre el nivel del suelo (km)",
                     limits = c(0, 2500)) +
  facet_wrap(~regimen, scales = "free") +
  #labs(title = "Perfiles a partir del promedio del dominio") +
  coord_flip() +
  theme_minimal()

remove(d)
```

# Conclusiones

Este trabajo de tesis tuvo como objetivo explorar la potencialidad del uso de datos de los radares Doppler en Argentina para estudiar algunos procesos que ocurren en la capa límite planetaria y validar un modelo numérico de la atmósfera analizando el desempeño de tres parametrizaciones de CLP. En primer lugar se determinaron las características necesarias para identificar los casos de estudio que permitan analizar los procesos de CLP asociados al ciclo diario. Para eso se analizaron los datos del Radar Doppler INTA Paraná y de la estación meteorológica Paraná Aero en busca de días con cielos despejados (o en su defecto, donde la nubosidad no tenga un efecto significativo sobre la temperatura observada) y con vientos moderados (menor a 7 m/s) durante el mes de enero de 2016. A partir de los criterios establecidos se identificaron tres casos correspondientes a tres días desde las 00 UTC: 14, 21 y 23 de enero.

Para el procesamiento de los datos de radar se desarrolló un algoritmo basado en la técnica de Visualización Azimutal de la Velocidad (VAD) que permitió la obtención de perfiles verticales de la velocidad del viento horizontal a partir de la velocidad radial medida por el radar. En esta técnica se incluyeron controles de calidad para asegurar la validez de los resultados teniendo en cuenta distintas fuentes de errores posibles. En este trabajo se aplicaron controles para limitar la presencia de datos faltantes dispersos y consecutivos, se determinaron los límites del dominio donde el cálculo es posible y los ángulos de elevación del radar utilizados. Posteriormente se definió un umbral mínimo para eliminar datos que no tuvieran un buen ajuste al modelo propuesto a partir del $R^2$. Para validar la técnica de VAD desarrollada se construyeron campos de velocidad radial sintéticos con distintos errores a partir de los datos de un sondeo y se compararon los perfiles resultantes con el sondeo inicial y con el perfil obtenido a partir de los datos de un radar cercano. A partir de estas comparaciones se concluyó que el algoritmo tiene un buen desempeño aunque la presencia de datos faltantes genera un aumento en los errores calculados.

A partir de los perfiles verticales del viento para cada caso en estudio se analizaron las características principales de la variación del viento a lo largo del día. Si bien en algunos momentos los errores calculados por el VAD son importantes, la resolución tanto espacial como temporal permitieron observar la evolución diaria de la capa límite  hasta alturas que van entre 1000 y 3000 m de altura. En los tres casos seleccionados se observó el desarrollo del LLJ durante las horas nocturnas con el máximo viento entre 15 y 16 m/s y entre 200 y 400 m de altura. El criterio de Bonner permitió identificar el LLJ en cada caso de manera cuantitativa y sin ambigüedades ya que los perfiles verticales presentaron un único máximo.

El análisis de las hodógrafas temporales de viento permitió comparar cualitativamente las observaciones con el modelo de oscilación inercial propuesto por Van de Wiel. Todos los casos presentaron concordancia con el modelo incluyendo la variación de la oscilación inercial con la altura. Si bien no se estudiaron otros mecanismos asociados al desarrollo del LLJ, el buen ajuste al modelo de oscilación inercial permitió identificarlo como el mecanismo principal. Para validar esto de manera cualitativa, a futuro sería necesario contar con datos de viento geostrófico y su variación con la altura.

Se estimó la altura de la capa estable nocturna utilizando dos métodos diferentes, como la altura a la que ocurre el máximo viento del LLJ y de acuerdo a la máxima variación del gradiente vertical de reflectividad. Las estimaciones coincidieron en dos de los casos estudiados dándole robustez al segundo método. A partir del cálculo del número de Richardson Bulk se pudo determinar que la capa estable nocturna se mantuvo estáticamente estable durante las horas del LLJ pero en presencia de un flujo turbulento gracias a la cortante existente.

En los tres casos se observó el desarrollo de la capa mezclada posterior a la salida del sol. El viento observado por el radar se mantuvo aproximadamente constante con la altura a partir de los 100 a 200 m y con menor magnitud respecto a lo observado en horas nocturnas. Solo en el Caso 1 pudo verse el aumento en la magnitud del viento al final del día correspondiente al debilitamiento de la capa mezclada luego del atardecer. La estimación de la altura de la capa mezclada utilizando el gradiente vertical de reflectividad fue acorde a lo esperado teóricamente aunque hace evidente la necesidad de desarrollar una técnica que permita determinar el tope de la capa sin ambigüedades utilizando distintos ángulos de elevación y otras variables asociadas a la reflectividad.

En la segunda etapa de este trabajo se realizaron simulaciones numéricas con el modelo regional WRF utilizando tres parametrizaciones de capa límite. Se seleccionó la parametrización YSU con clausura no local, MYJ con clausura local y ACM2 que tiene un comportamiento mixto. Se definió un dominio alrededor del radar y se utilizaron condiciones iniciales adecuadas para modelar el Caso 1. En términos cualitativos las tres simulaciones lograron representar las condiciones generales observadas durante período correspondiente. En particular las simulaciones lograron representar la evolución de la magnitud del viento, el LLJ durante la noche y el perfil homogéneo típico de la capa mezclada. Los campos de diferencias en la magnitud del viento entre las observaciones y cada simulación mostraron un mínimo alrededor de 500 m donde el error total fue menor en las tres comparaciones. Por debajo de ese nivel el bias resultó positivo y negativo por encima y este último dominó globalmente. La correlación entre las observaciones y las simulaciones fue muy buena hasta 600 m, pero luego desciende rápidamente y llega a valores negativos. Esto puede deberse a que la oscilación inercial en las tres simulaciones se observa hasta alturas menores que la estimación realizada por el radar. La diferencia calculada para la dirección del viento muestra un patrón similar en las tres simulaciones, diferencias pequeñas o nulas en los primeros 1000 m que luego crecen en los niveles superiores hasta valores cercanos a 140°. Al igual que con la magnitud del viento, el bias fue negativo y la correlación fue similar en los tres casos con valores cercanos a 0.5.

A partir de lo anterior puede concluirse que las tres simulaciones tuvieron un mejor desempeño en los primeros 600 a 1000 m de altura. MYJ presentó un mayor error total y menor correlación en la magnitud del viento pero fue el mejor al simular su dirección. A pesar de sus diferencias, YSU y ACM2 tienen un comportamiento muy similar por lo que la componente no local de la parametrización ACM2 domina la simulación. Por encima de los 1000 m de altura el desempeño disminuye y por lo tanto las simulaciones podrían no estar representando de manera correcta los procesos que ocurren en la atmósfera. Sin embargo también es posible que parte de esa diferencia esté asociada a un error en la estimación de los perfiles con la técnica VAD debido a los errores de aproximación generados en el cálculo de la propagación vertical del haz de radar. Este problema es más importante durante la noche cuando se produce una inversión térmica que puede afectar significativamente la altura del haz.

El LLJ simulado se prolonga entre una y dos horas más de lo observado y el máximo de viento es ligeramente superior. Cualitativamente el modelo de Van de Wiel se ajusta ya que las hodógrafas tienen la forma característica de herradura y presentan concordancia con las observaciones hasta los 500 m. Pero en niveles superiores esto no ocurre, en las tres simulaciones la hodógrafa pierde totalmente la forma y el viento tiene menor magnitud respecto de las observaciones, indicando que la oscilación inercial no llega hasta niveles altos.

Se comparó la altura de la capa límite calculada por cada parametrización con la estimación realizada para la capa estable nocturna y con el gradiente vertical de la reflectividad. Las variaciones entre las simulaciones puede deberse a que cada parametrización estima este parámetro de manera distinta, sin embargo las tres convergen principalmente durante el período nocturno. En este mismo período MYJ y ACM2 logran representar la altura de la capa estable durante la presencia del LLJ de manera satisfactoria. La comparación con el gradiente vertical de reflectividad muestra que la capa estable nocturna persiste dos horas luego del amanecer a diferencias de las observaciones donde la capa mezclada empieza a desarrollarse inmediatamente. Esto podría explicar la extensión temporal del LLJ observado en las simulaciones. Posteriormente la altura de la capa límite crece lentamente superando el tope medido por las observaciones en el caso de YSU y ACM2. Por otro lado MYJ muestra cierta concordancia con las observaciones en las primeras horas del día y luego cuando ocurre la mayor profundidad de la capa límite. El desempeño de MYJ al representar la altura de la capa límite podría estar indicando que el transporte local de las distintas propiedades es suficiente para desarrollar la profundidad de la capa a través de pequeños torbellinos.

El análisis de los coeficientes de difusividad turbulenta permitió entender algunas de las características de la estructura de la capa límite. Los perfiles de las simulaciones en el régimen estable (nocturno) no presentaron la estructura esperada y asociada a la turbulencia dentro de la capa límite estable. Por el contrario, se observó un máximo por encima de la capa que podría estar asociado a la intensa cortante por encima del LLJ. En concordancia con observaciones previas la mezcla débil generada por MYJ está asociada a un LLJ más intenso mientras que en YSU y ACM2 ocurre lo contrario debido a una mayor divergencia de cantidad de movimiento que debilita el LLJ. Durante el día los perfiles muestran un máximo dentro de la capa mezclada y la profundidad de la mezcla en cada simulación concuerda con la altura de la capa mezclada estimada por cada esquema.

Finalmente se proponen algunas posible mejoras en la implementación de la técnica VAD y su uso en otras situaciones meteorológicas. Éstas incluyen una mejor determinación de la propagación del haz de radar con la posibilidad de usar simulaciones numéricas para determinar los perfiles de temperatura y humedad, mejorar el tratamiento de aliasing y otros problemas asociados al viento radial utilizando técnicas más complejas que tengan en cuenta la consistencia temporal de los datos, implementar técnicas de suavizado espacio-temporal como el filtro de Kalman para mejorar la suavidad de los perfiles y hacerlos más robustos frente a los datos faltantes o erróneos, estudiar la posibilidad de incorporar cambios en el algoritmo que permitan eliminar la condición de linealidad del campo de viento horizontal para analizar otros procesos asociados a la mesoescala y estudiar en profundidad los datos de radar de 120 km de rango para poder utilizarlos de manera eficiente.

Para extender el análisis de los procesos asociados a la CLP en futuros trabajos sería importante el estudio de días consecutivos para mejorar la comprensión de las características de la capa límite y cómo influye en la formación de la capa límite subsiguiente y el LLJ nocturno, incluir mediciones de turbulencia que permitan ampliar el análisis de las características de la CLP, utilizar cuando sea posible datos de radares como Resistencia, Ezeiza o Anguil donde se realizan mediciones con radiosondeos para ampliar los datos disponibles, realizar experimentos de simulación numérica sobre un número mayor de casos de forma tal de poder estudiar los errores sistemáticos asociados a cada parametrización, evaluar la sensibilidad de las parametrizaciones a sus parámetros y evaluar una posible optimización de dichos parámetros utilizando las observaciones de radar.


# Referencias
